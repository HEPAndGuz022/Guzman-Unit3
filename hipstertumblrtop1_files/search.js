/*! scripts/search/utils/search_session_log.js */
Tumblr.Search||(Tumblr.Search={});(function(){var b=Tumblr.log_lady;var a=b.Log.extend({log_key:"search_session_v1",defaults:{init_event:true,keep_counts:true},initialize:function(){var c=b.watching.search_session_v1;if(this.options.init_event&&c){this.options.init_event=false;this.trigger("init",{previous:{env:c.env,uuid:c.uuid}})}b.watch(this)},before_replaced:function(c){this.unloaded({next:{env:c.env,uuid:c.uuid}})}},{trigger:function(){var c=this.log_instance();if(c){return c.trigger.apply(c,arguments)}else{this._trigger_q||(this._trigger_q=[]);this._trigger_q.push([].slice.apply(arguments));return false}},set_search_model:function(c){if(this.search_model){this.search_model.off("query:change:posts",this.new_log_instance)}this.search_model=c;this.search_model.on("query:change:posts",this.new_log_instance,this);var d=this.log_instance();if(d){_.each(this._trigger_q,function(e){d.trigger.apply(e)})}},new_log_instance:function(){this._log_instance=null;this.log_instance()},log_instance:function(){if(!this._log_instance&&this.search_model){var d=this.search_model.log_lady_env();var c=this.search_model.generate_search_session_id();this._log_instance=new a({uuid:c,env:d});Tumblr.Events.trigger("search:session:change:uuid",{uuid:c})}return this._log_instance}});Tumblr.Search.SearchSessionLog=a})();
/*! scripts/vendor/iscroll/iscroll-probe.custom.js */
/*! iScroll v5.0.5 ~ (c) 2008-2013 Matteo Spinelli ~ http://cubiq.org/license */
var IScroll=(function(f,a,e){var h=f.requestAnimationFrame||f.webkitRequestAnimationFrame||f.mozRequestAnimationFrame||f.oRequestAnimationFrame||f.msRequestAnimationFrame||function(i){f.setTimeout(i,1000/60)};var c=(function(){var m={};var n=a.createElement("div").style;var k=(function(){var r=["t","webkitT","MozT","msT","OT"],p,q=0,o=r.length;for(;q<o;q++){p=r[q]+"ransform";if(p in n){return r[q].substr(0,r[q].length-1)}}return false})();function l(o){if(k===false){return false}if(k===""){return o}return k+o.charAt(0).toUpperCase()+o.substr(1)}m.getTime=Date.now||function i(){return new Date().getTime()};m.extend=function(q,p){for(var o in p){q[o]=p[o]}};m.addEvent=function(r,q,p,o){r.addEventListener(q,p,!!o)};m.removeEvent=function(r,q,p,o){r.removeEventListener(q,p,!!o)};m.momentum=function(v,q,r,o,w){var p=v-q,s=e.abs(p)/r,x,t,u=0.0006;x=v+(s*s)/(2*u)*(p<0?-1:1);t=s/u;if(x<o){x=w?o-(w/2.5*(s/8)):o;p=e.abs(x-v);t=p/s}else{if(x>0){x=w?w/2.5*(s/8):0;p=e.abs(v)+x;t=p/s}}return{destination:e.round(x),duration:t}};var j=l("transform");m.extend(m,{hasTransform:j!==false,hasPerspective:l("perspective") in n,hasTouch:"ontouchstart" in f,hasPointer:navigator.msPointerEnabled,hasTransition:l("transition") in n});m.isAndroidBrowser=/Android/.test(f.navigator.appVersion)&&/Version\/\d/.test(f.navigator.appVersion);m.extend(m.style={},{transform:j,transitionTimingFunction:l("transitionTimingFunction"),transitionDuration:l("transitionDuration"),transformOrigin:l("transformOrigin")});m.hasClass=function(p,q){var o=new RegExp("(^|\\s)"+q+"(\\s|$)");return o.test(p.className)};m.addClass=function(p,q){if(m.hasClass(p,q)){return}var o=p.className.split(" ");o.push(q);p.className=o.join(" ")};m.removeClass=function(p,q){if(!m.hasClass(p,q)){return}var o=new RegExp("(^|\\s)"+q+"(\\s|$)","g");p.className=p.className.replace(o," ")};m.offset=function(o){var q=-o.offsetLeft,p=-o.offsetTop;while(o=o.offsetParent){q-=o.offsetLeft;p-=o.offsetTop}return{left:q,top:p}};m.preventDefaultException=function(q,p){for(var o in p){if(p[o].test(q[o])){return true}}return false};m.extend(m.eventType={},{touchstart:1,touchmove:1,touchend:1,mousedown:2,mousemove:2,mouseup:2,MSPointerDown:3,MSPointerMove:3,MSPointerUp:3});m.extend(m.ease={},{quadratic:{style:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",fn:function(o){return o*(2-o)}},circular:{style:"cubic-bezier(0.1, 0.57, 0.1, 1)",fn:function(o){return e.sqrt(1-(--o*o))}},back:{style:"cubic-bezier(0.175, 0.885, 0.32, 1.275)",fn:function(p){var o=4;return(p=p-1)*p*((o+1)*p+o)+1}},bounce:{style:"",fn:function(o){if((o/=1)<(1/2.75)){return 7.5625*o*o}else{if(o<(2/2.75)){return 7.5625*(o-=(1.5/2.75))*o+0.75}else{if(o<(2.5/2.75)){return 7.5625*(o-=(2.25/2.75))*o+0.9375}else{return 7.5625*(o-=(2.625/2.75))*o+0.984375}}}}},elastic:{style:"",fn:function(o){var p=0.22,q=0.4;if(o===0){return 0}if(o==1){return 1}return(q*e.pow(2,-10*o)*e.sin((o-p/4)*(2*e.PI)/p)+1)}}});m.tap=function(q,o){var p=a.createEvent("Event");p.initEvent(o,true,true);p.pageX=q.pageX;p.pageY=q.pageY;q.target.dispatchEvent(p)};m.click=function(q){var p=q.target,o;if(p.tagName!="SELECT"&&p.tagName!="INPUT"&&p.tagName!="TEXTAREA"){o=a.createEvent("MouseEvents");o.initMouseEvent("click",true,true,q.view,1,p.screenX,p.screenY,p.clientX,p.clientY,q.ctrlKey,q.altKey,q.shiftKey,q.metaKey,0,null);o._constructed=true;p.dispatchEvent(o)}};return m})();function g(l,j){this.wrapper=typeof l=="string"?a.querySelector(l):l;this.scroller=this.wrapper.children[0];this.scrollerStyle=this.scroller.style;this.options={resizeIndicator:true,mouseWheelSpeed:20,snapThreshold:0.334,startX:0,startY:0,scrollY:true,directionLockThreshold:5,momentum:true,bounce:true,bounceTime:600,bounceEasing:"",preventDefault:true,preventDefaultException:{tagName:/^(INPUT|TEXTAREA|BUTTON|SELECT)$/},HWCompositing:true,useTransition:true,useTransform:true,reverseHorizontalScroll:true};for(var k in j){this.options[k]=j[k]}this.translateZ=this.options.HWCompositing&&c.hasPerspective?" translateZ(0)":"";this.options.useTransition=c.hasTransition&&this.options.useTransition;this.options.useTransform=c.hasTransform&&this.options.useTransform;this.options.eventPassthrough=this.options.eventPassthrough===true?"vertical":this.options.eventPassthrough;this.options.preventDefault=!this.options.eventPassthrough&&this.options.preventDefault;this.options.scrollY=this.options.eventPassthrough=="vertical"?false:this.options.scrollY;this.options.scrollX=this.options.eventPassthrough=="horizontal"?false:this.options.scrollX;this.options.freeScroll=this.options.freeScroll&&!this.options.eventPassthrough;this.options.directionLockThreshold=this.options.eventPassthrough?0:this.options.directionLockThreshold;this.options.bounceEasing=typeof this.options.bounceEasing=="string"?c.ease[this.options.bounceEasing]||c.ease.circular:this.options.bounceEasing;this.options.resizePolling=this.options.resizePolling===undefined?60:this.options.resizePolling;if(this.options.tap===true){this.options.tap="tap"}this.options.invertWheelDirection=this.options.invertWheelDirection?-1:1;if(this.options.probeType==3){this.options.useTransition=false}this.x=0;this.y=0;this.directionX=0;this.directionY=0;this._events={};this._init();this.refresh();this.scrollTo(this.options.startX,this.options.startY);this.enable()}g.prototype={version:"5.0.5",_init:function(){this._initEvents();if(this.options.scrollbars||this.options.indicators){this._initIndicators()}if(this.options.mouseWheel){this._initWheel()}if(this.options.snap){this._initSnap()}if(this.options.keyBindings){this._initKeys()}},destroy:function(){this._initEvents(true);this._execEvent("destroy")},_transitionEnd:function(i){if(i.target!=this.scroller){return}this._transitionTime(0);if(!this.resetPosition(this.options.bounceTime)){this._execEvent("scrollEnd")}},_start:function(j){if(c.eventType[j.type]!=1){if(j.button!==0){return}}if(!this.enabled||(this.initiated&&c.eventType[j.type]!==this.initiated)){return}if(this.options.preventDefault&&!c.isAndroidBrowser&&!c.preventDefaultException(j.target,this.options.preventDefaultException)){j.preventDefault()}var i=j.touches?j.touches[0]:j,k;this.initiated=c.eventType[j.type];this.moved=false;this.distX=0;this.distY=0;this.directionX=0;this.directionY=0;this.directionLocked=0;this._transitionTime();this.isAnimating=false;this.startTime=c.getTime();if(this.options.useTransition&&this.isInTransition){k=this.getComputedPosition();this._translate(e.round(k.x),e.round(k.y));this.isInTransition=false}this.startX=this.x;this.startY=this.y;this.absStartX=this.x;this.absStartY=this.y;this.pointX=i.pageX;this.pointY=i.pageY;this._execEvent("scrollStart")},_move:function(n){if(!this.enabled||c.eventType[n.type]!==this.initiated){return}if(this.options.preventDefault){n.preventDefault()}var p=n.touches?n.touches[0]:n,k=this.hasHorizontalScroll?p.pageX-this.pointX:0,j=this.hasVerticalScroll?p.pageY-this.pointY:0,o=c.getTime(),i,q,m,l;this.pointX=p.pageX;this.pointY=p.pageY;this.distX+=k;this.distY+=j;m=e.abs(this.distX);l=e.abs(this.distY);if(o-this.endTime>300&&(m<10&&l<10)){return}if(!this.directionLocked&&!this.options.freeScroll){if(m>l+this.options.directionLockThreshold){this.directionLocked="h"}else{if(l>=m+this.options.directionLockThreshold){this.directionLocked="v"}else{this.directionLocked="n"}}}if(this.directionLocked=="h"){if(this.options.eventPassthrough=="vertical"){n.preventDefault()}else{if(this.options.eventPassthrough=="horizontal"){this.initiated=false;return}}j=0}else{if(this.directionLocked=="v"){if(this.options.eventPassthrough=="horizontal"){n.preventDefault()}else{if(this.options.eventPassthrough=="vertical"){this.initiated=false;return}}k=0}}i=this.x+k;q=this.y+j;if(i>0||i<this.maxScrollX){i=this.options.bounce?this.x+k/3:i>0?0:this.maxScrollX}if(q>0||q<this.maxScrollY){q=this.options.bounce?this.y+j/3:q>0?0:this.maxScrollY}this.directionX=k>0?-1:k<0?1:0;this.directionY=j>0?-1:j<0?1:0;this.moved=true;this._translate(i,q);if(o-this.startTime>300){this.startTime=o;this.startX=this.x;this.startY=this.y;if(this.options.probeType==1){this._execEvent("scroll")}}if(this.options.probeType>1){this._execEvent("scroll")}},_end:function(o){if(!this.enabled||c.eventType[o.type]!==this.initiated){return}if(this.options.preventDefault&&!c.preventDefaultException(o.target,this.options.preventDefaultException)){o.preventDefault()}var q=o.changedTouches?o.changedTouches[0]:o,k,j,n=c.getTime()-this.startTime,i=e.round(this.x),t=e.round(this.y),s=e.abs(i-this.startX),r=e.abs(t-this.startY),l=0,p="";this.scrollTo(i,t);this.isInTransition=0;this.initiated=0;this.endTime=c.getTime();if(this.resetPosition(this.options.bounceTime)){return}if(!this.moved){if(this.options.tap){c.tap(o,this.options.tap)}if(this.options.click){c.click(o)}return}if(this._events.flick&&n<200&&s<100&&r<100){this._execEvent("flick");return}if(this.options.momentum&&n<300){k=this.hasHorizontalScroll?c.momentum(this.x,this.startX,n,this.maxScrollX,this.options.bounce?this.wrapperWidth:0):{destination:i,duration:0};j=this.hasVerticalScroll?c.momentum(this.y,this.startY,n,this.maxScrollY,this.options.bounce?this.wrapperHeight:0):{destination:t,duration:0};i=k.destination;t=j.destination;l=e.max(k.duration,j.duration);this.isInTransition=1}if(this.options.snap){var m=this._nearestSnap(i,t);this.currentPage=m;l=this.options.snapSpeed||e.max(e.max(e.min(e.abs(i-m.x),1000),e.min(e.abs(t-m.y),1000)),300);i=m.x;t=m.y;this.directionX=0;this.directionY=0;p=this.options.bounceEasing}if(i!=this.x||t!=this.y){if(i>0||i<this.maxScrollX||t>0||t<this.maxScrollY){p=c.ease.quadratic}this.scrollTo(i,t,l,p);return}this._execEvent("scrollEnd")},_resize:function(){var i=this;clearTimeout(this.resizeTimeout);this.resizeTimeout=setTimeout(function(){i.refresh()},this.options.resizePolling)},resetPosition:function(j){var i=this.x,k=this.y;j=j||0;if(!this.hasHorizontalScroll||this.x>0){i=0}else{if(this.x<this.maxScrollX){i=this.maxScrollX}}if(!this.hasVerticalScroll||this.y>0){k=0}else{if(this.y<this.maxScrollY){k=this.maxScrollY}}if(i==this.x&&k==this.y){return false}this.scrollTo(i,k,j,this.options.bounceEasing);return true},disable:function(){this.enabled=false},enable:function(){this.enabled=true},refresh:function(){var i=this.wrapper.offsetHeight;this.wrapperWidth=this.wrapper.clientWidth;this.wrapperHeight=this.wrapper.clientHeight;this.scrollerWidth=this.scroller.offsetWidth;this.scrollerHeight=this.scroller.offsetHeight;this.maxScrollX=this.wrapperWidth-this.scrollerWidth;this.maxScrollY=this.wrapperHeight-this.scrollerHeight;this.hasHorizontalScroll=this.options.scrollX&&this.maxScrollX<0;this.hasVerticalScroll=this.options.scrollY&&this.maxScrollY<0;if(!this.hasHorizontalScroll){this.maxScrollX=0;this.scrollerWidth=this.wrapperWidth}if(!this.hasVerticalScroll){this.maxScrollY=0;this.scrollerHeight=this.wrapperHeight}this.endTime=0;this.directionX=0;this.directionY=0;this.wrapperOffset=c.offset(this.wrapper);this._execEvent("refresh");this.resetPosition()},on:function(j,i){if(!this._events[j]){this._events[j]=[]}this._events[j].push(i)},_execEvent:function(m){if(!this._events[m]){return}var k=0,j=this._events[m].length;if(!j){return}for(;k<j;k++){this._events[m][k].call(this)}},scrollBy:function(i,l,j,k){i=this.x+i;l=this.y+l;j=j||0;this.scrollTo(i,l,j,k)},scrollTo:function(i,l,j,k){k=k||c.ease.circular;if(!j||(this.options.useTransition&&k.style)){this._transitionTimingFunction(k.style);this._transitionTime(j);this._translate(i,l)}else{this._animate(i,l,j,k.fn)}},scrollToElement:function(j,k,i,n,m){j=j.nodeType?j:this.scroller.querySelector(j);if(!j){return}var l=c.offset(j);l.left-=this.wrapperOffset.left;l.top-=this.wrapperOffset.top;if(i===true){i=e.round(j.offsetWidth/2-this.wrapper.offsetWidth/2)}if(n===true){n=e.round(j.offsetHeight/2-this.wrapper.offsetHeight/2)}l.left-=i||0;l.top-=n||0;l.left=l.left>0?0:l.left<this.maxScrollX?this.maxScrollX:l.left;l.top=l.top>0?0:l.top<this.maxScrollY?this.maxScrollY:l.top;k=k===undefined||k===null||k==="auto"?e.max(e.abs(this.x-l.left),e.abs(this.y-l.top)):k;this.scrollTo(l.left,l.top,k,m)},_transitionTime:function(i){i=i||0;this.scrollerStyle[c.style.transitionDuration]=i+"ms";if(this.indicator1){this.indicator1.transitionTime(i)}if(this.indicator2){this.indicator2.transitionTime(i)}},_transitionTimingFunction:function(i){this.scrollerStyle[c.style.transitionTimingFunction]=i;if(this.indicator1){this.indicator1.transitionTimingFunction(i)}if(this.indicator2){this.indicator2.transitionTimingFunction(i)}},_translate:function(i,j){if(this.options.useTransform){this.scrollerStyle[c.style.transform]="translate("+i+"px,"+j+"px)"+this.translateZ}else{i=e.round(i);j=e.round(j);this.scrollerStyle.left=i+"px";this.scrollerStyle.top=j+"px"}this.x=i;this.y=j;if(this.indicator1){this.indicator1.updatePosition()}if(this.indicator2){this.indicator2.updatePosition()}},_initEvents:function(i){var j=i?c.removeEvent:c.addEvent,k=this.options.bindToWrapper?this.wrapper:f;j(f,"orientationchange",this);j(f,"resize",this);if(!this.options.disableMouse){j(this.wrapper,"mousedown",this);j(k,"mousemove",this);j(k,"mousecancel",this);j(k,"mouseup",this)}if(c.hasPointer){j(this.wrapper,"MSPointerDown",this);j(k,"MSPointerMove",this);j(k,"MSPointerCancel",this);j(k,"MSPointerUp",this)}if(c.hasTouch){j(this.wrapper,"touchstart",this);j(k,"touchmove",this);j(k,"touchcancel",this);j(k,"touchend",this)}j(this.scroller,"transitionend",this);j(this.scroller,"webkitTransitionEnd",this);j(this.scroller,"oTransitionEnd",this);j(this.scroller,"MSTransitionEnd",this)},getComputedPosition:function(){var j=f.getComputedStyle(this.scroller,null),i,k;if(this.options.useTransform){j=j[c.style.transform].split(")")[0].split(", ");i=+(j[12]||j[4]);k=+(j[13]||j[5])}else{i=+j.left.replace(/[^-\d]/g,"");k=+j.top.replace(/[^-\d]/g,"")}return{x:i,y:k}},_initIndicators:function(){var i=this.options.interactiveScrollbars,k=typeof this.options.scrollbars!="object",j=typeof this.options.scrollbars!="string",m,l;if(this.options.scrollbars){if(this.options.scrollY){m={el:d("v",i,this.options.scrollbars),interactive:i,defaultScrollbars:true,customStyle:j,resize:this.options.resizeIndicator,listenX:false};this.wrapper.appendChild(m.el)}if(this.options.scrollX){l={el:d("h",i,this.options.scrollbars),interactive:i,defaultScrollbars:true,customStyle:j,resize:this.options.resizeIndicator,listenY:false};this.wrapper.appendChild(l.el)}}else{m=this.options.indicators.length?this.options.indicators[0]:this.options.indicators;l=this.options.indicators[1]&&this.options.indicators[1]}if(m){this.indicator1=new b(this,m)}if(l){this.indicator2=new b(this,l)}this.on("refresh",function(){if(this.indicator1){this.indicator1.refresh()}if(this.indicator2){this.indicator2.refresh()}});this.on("destroy",function(){if(this.indicator1){this.indicator1.destroy();this.indicator1=null}if(this.indicator2){this.indicator2.destroy();this.indicator2=null}})},_initWheel:function(){c.addEvent(this.wrapper,"mousewheel",this);c.addEvent(this.wrapper,"DOMMouseScroll",this);this.on("destroy",function(){c.removeEvent(this.wrapper,"mousewheel",this);c.removeEvent(this.wrapper,"DOMMouseScroll",this)})},_wheel:function(m){if(!this.enabled){return}var k,j,n,l,i=this;clearTimeout(this.wheelTimeout);this.wheelTimeout=setTimeout(function(){i.directionLocked=0;i._execEvent("scrollEnd")},400);if("wheelDeltaX" in m){k=m.wheelDeltaX/120;j=m.wheelDeltaY/120}else{if("wheelDelta" in m){k=j=m.wheelDelta/120}else{if("detail" in m){k=j=-m.detail/3}else{return}}}if("axis" in m){if(m.axis===1){j=0}else{k=0}}k*=this.options.mouseWheelSpeed;j*=this.options.mouseWheelSpeed;if(!this.hasVerticalScroll&&this.options.reverseHorizontalScroll){k=j;j=0}if(this.options.snap){n=this.currentPage.pageX;l=this.currentPage.pageY;if(k>0){n--}else{if(k<0){n++}}if(j>0){l--}else{if(j<0){l++}}this.goToPage(n,l);return}absDistX=e.abs(k);absDistY=e.abs(j);if(!this.directionLocked&&!this.options.freeScroll){if(absDistX>absDistY+this.options.directionLockThreshold){this.directionLocked="h"}else{if(absDistY>=absDistX+this.options.directionLockThreshold){this.directionLocked="v"}else{this.directionLocked="n"}}}if(this.directionLocked=="h"){if(this.options.eventPassthrough=="vertical"){m.preventDefault()}else{if(this.options.eventPassthrough=="horizontal"){this.initiated=false;return}}j=0}else{if(this.directionLocked=="v"){if(this.options.eventPassthrough=="horizontal"){m.preventDefault()}else{if(this.options.eventPassthrough=="vertical"){this.initiated=false;return}}k=0}}n=e.round(this.x+(this.hasHorizontalScroll?k*this.options.invertWheelDirection:0));l=e.round(this.y+(this.hasVerticalScroll?j*this.options.invertWheelDirection:0));if(n>0){n=0}else{if(n<this.maxScrollX){n=this.maxScrollX}}if(l>0){l=0}else{if(l<this.maxScrollY){l=this.maxScrollY}}this.scrollTo(n,l,0);if(this.options.probeType>1){this._execEvent("scroll")}},_initSnap:function(){this.currentPage={};if(typeof this.options.snap=="string"){this.options.snap=this.scroller.querySelectorAll(this.options.snap)}this.on("refresh",function(){var s=0,q,o=0,k,r,p,u=0,t,w=this.options.snapStepX||this.wrapperWidth,v=this.options.snapStepY||this.wrapperHeight,j;this.pages=[];if(!this.wrapperWidth||!this.wrapperHeight||!this.scrollerWidth||!this.scrollerHeight){return}if(this.options.snap===true){r=e.round(w/2);p=e.round(v/2);while(u>-this.scrollerWidth){this.pages[s]=[];q=0;t=0;while(t>-this.scrollerHeight){this.pages[s][q]={x:e.max(u,this.maxScrollX),y:e.max(t,this.maxScrollY),width:w,height:v,cx:u-r,cy:t-p};t-=v;q++}u-=w;s++}}else{j=this.options.snap;q=j.length;k=-1;for(;s<q;s++){if(s===0||j[s].offsetLeft<=j[s-1].offsetLeft){o=0;k++}if(!this.pages[o]){this.pages[o]=[]}u=e.max(-j[s].offsetLeft,this.maxScrollX);t=e.max(-j[s].offsetTop,this.maxScrollY);r=u-e.round(j[s].offsetWidth/2);p=t-e.round(j[s].offsetHeight/2);this.pages[o][k]={x:u,y:t,width:j[s].offsetWidth,height:j[s].offsetHeight,cx:r,cy:p};if(u>this.maxScrollX){o++}}}this.goToPage(this.currentPage.pageX||0,this.currentPage.pageY||0,0);if(this.options.snapThreshold%1===0){this.snapThresholdX=this.options.snapThreshold;this.snapThresholdY=this.options.snapThreshold}else{this.snapThresholdX=e.round(this.pages[this.currentPage.pageX][this.currentPage.pageY].width*this.options.snapThreshold);this.snapThresholdY=e.round(this.pages[this.currentPage.pageX][this.currentPage.pageY].height*this.options.snapThreshold)}});this.on("flick",function(){var i=this.options.snapSpeed||e.max(e.max(e.min(e.abs(this.x-this.startX),1000),e.min(e.abs(this.y-this.startY),1000)),300);this.goToPage(this.currentPage.pageX+this.directionX,this.currentPage.pageY+this.directionY,i)})},_nearestSnap:function(k,p){if(!this.pages.length){return{x:0,y:0,pageX:0,pageY:0}}var o=0,n=this.pages.length,j=0;if(e.abs(k-this.absStartX)<this.snapThresholdX&&e.abs(p-this.absStartY)<this.snapThresholdY){return this.currentPage}if(k>0){k=0}else{if(k<this.maxScrollX){k=this.maxScrollX}}if(p>0){p=0}else{if(p<this.maxScrollY){p=this.maxScrollY}}for(;o<n;o++){if(k>=this.pages[o][0].cx){k=this.pages[o][0].x;break}}n=this.pages[o].length;for(;j<n;j++){if(p>=this.pages[0][j].cy){p=this.pages[0][j].y;break}}if(o==this.currentPage.pageX){o+=this.directionX;if(o<0){o=0}else{if(o>=this.pages.length){o=this.pages.length-1}}k=this.pages[o][0].x}if(j==this.currentPage.pageY){j+=this.directionY;if(j<0){j=0}else{if(j>=this.pages[0].length){j=this.pages[0].length-1}}p=this.pages[0][j].y}return{x:k,y:p,pageX:o,pageY:j}},goToPage:function(i,n,j,m){m=m||this.options.bounceEasing;if(i>=this.pages.length){i=this.pages.length-1}else{if(i<0){i=0}}if(n>=this.pages[i].length){n=this.pages[i].length-1}else{if(n<0){n=0}}var l=this.pages[i][n].x,k=this.pages[i][n].y;j=j===undefined?this.options.snapSpeed||e.max(e.max(e.min(e.abs(l-this.x),1000),e.min(e.abs(k-this.y),1000)),300):j;this.currentPage={x:l,y:k,pageX:i,pageY:n};this.scrollTo(l,k,j,m)},next:function(j,l){var i=this.currentPage.pageX,k=this.currentPage.pageY;i++;if(i>=this.pages.length&&this.hasVerticalScroll){i=0;k++}this.goToPage(i,k,j,l)},prev:function(j,l){var i=this.currentPage.pageX,k=this.currentPage.pageY;i--;if(i<0&&this.hasVerticalScroll){i=0;k--}this.goToPage(i,k,j,l)},_initKeys:function(l){var k={pageUp:33,pageDown:34,end:35,home:36,left:37,up:38,right:39,down:40};var j;if(typeof this.options.keyBindings=="object"){for(j in this.options.keyBindings){if(typeof this.options.keyBindings[j]=="string"){this.options.keyBindings[j]=this.options.keyBindings[j].toUpperCase().charCodeAt(0)}}}else{this.options.keyBindings={}}for(j in k){this.options.keyBindings[j]=this.options.keyBindings[j]||k[j]}c.addEvent(f,"keydown",this);this.on("destroy",function(){c.removeEvent(f,"keydown",this)})},_key:function(n){if(!this.enabled){return}var i=this.options.snap,o=i?this.currentPage.pageX:this.x,m=i?this.currentPage.pageY:this.y,k=c.getTime(),j=this.keyTime||0,l=0.25,p;if(this.options.useTransition&&this.isInTransition){p=this.getComputedPosition();this._translate(e.round(p.x),e.round(p.y));this.isInTransition=false}this.keyAcceleration=k-j<200?e.min(this.keyAcceleration+l,50):0;switch(n.keyCode){case this.options.keyBindings.pageUp:if(this.hasHorizontalScroll&&!this.hasVerticalScroll){o+=i?1:this.wrapperWidth}else{m+=i?1:this.wrapperHeight}break;case this.options.keyBindings.pageDown:if(this.hasHorizontalScroll&&!this.hasVerticalScroll){o-=i?1:this.wrapperWidth}else{m-=i?1:this.wrapperHeight}break;case this.options.keyBindings.end:o=i?this.pages.length-1:this.maxScrollX;m=i?this.pages[0].length-1:this.maxScrollY;break;case this.options.keyBindings.home:o=0;m=0;break;case this.options.keyBindings.left:o+=i?-1:5+this.keyAcceleration>>0;break;case this.options.keyBindings.up:m+=i?1:5+this.keyAcceleration>>0;break;case this.options.keyBindings.right:o-=i?-1:5+this.keyAcceleration>>0;break;case this.options.keyBindings.down:m-=i?1:5+this.keyAcceleration>>0;break}if(i){this.goToPage(o,m);return}if(o>0){o=0;this.keyAcceleration=0}else{if(o<this.maxScrollX){o=this.maxScrollX;this.keyAcceleration=0}}if(m>0){m=0;this.keyAcceleration=0}else{if(m<this.maxScrollY){m=this.maxScrollY;this.keyAcceleration=0}}this.scrollTo(o,m,0);this.keyTime=k},_animate:function(r,q,l,i){var o=this,n=this.x,m=this.y,j=c.getTime(),p=j+l;function k(){var s=c.getTime(),u,t,v;if(s>=p){o.isAnimating=false;o._translate(r,q);if(!o.resetPosition(o.options.bounceTime)){o._execEvent("scrollEnd")}return}s=(s-j)/l;v=i(s);u=(r-n)*v+n;t=(q-m)*v+m;o._translate(u,t);if(o.isAnimating){h(k)}if(o.options.probeType==3){o._execEvent("scroll")}}this.isAnimating=true;k()},handleEvent:function(i){switch(i.type){case"touchstart":case"MSPointerDown":case"mousedown":this._start(i);break;case"touchmove":case"MSPointerMove":case"mousemove":this._move(i);break;case"touchend":case"MSPointerUp":case"mouseup":case"touchcancel":case"MSPointerCancel":case"mousecancel":this._end(i);break;case"orientationchange":case"resize":this._resize();break;case"transitionend":case"webkitTransitionEnd":case"oTransitionEnd":case"MSTransitionEnd":this._transitionEnd(i);break;case"DOMMouseScroll":case"mousewheel":this._wheel(i);break;case"keydown":this._key(i);break}}};function d(l,j,k){var m=a.createElement("div"),i=a.createElement("div");if(k===true){m.style.cssText="position:absolute;z-index:9999";i.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;position:absolute;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.9);border-radius:3px"}i.className="iScrollIndicator";if(l=="h"){if(k===true){m.style.cssText+=";height:7px;left:2px;right:2px;bottom:0";i.style.height="100%"}m.className="iScrollHorizontalScrollbar"}else{if(k===true){m.style.cssText+=";width:7px;bottom:2px;top:2px;right:1px";i.style.width="100%"}m.className="iScrollVerticalScrollbar"}if(!j){m.style.pointerEvents="none"}m.appendChild(i);return m}function b(j,k){this.wrapper=typeof k.el=="string"?a.querySelector(k.el):k.el;this.indicator=this.wrapper.children[0];this.indicatorStyle=this.indicator.style;this.scroller=j;this.options={listenX:true,listenY:true,interactive:false,resize:true,defaultScrollbars:false,speedRatioX:0,speedRatioY:0};for(var l in k){this.options[l]=k[l]}this.sizeRatioX=1;this.sizeRatioY=1;this.maxPosX=0;this.maxPosY=0;if(this.options.interactive){c.addEvent(this.indicator,"touchstart",this);c.addEvent(this.indicator,"MSPointerDown",this);c.addEvent(this.indicator,"mousedown",this);c.addEvent(f,"touchend",this);c.addEvent(f,"MSPointerUp",this);c.addEvent(f,"mouseup",this)}}b.prototype={handleEvent:function(i){switch(i.type){case"touchstart":case"MSPointerDown":case"mousedown":this._start(i);break;case"touchmove":case"MSPointerMove":case"mousemove":this._move(i);break;case"touchend":case"MSPointerUp":case"mouseup":case"touchcancel":case"MSPointerCancel":case"mousecancel":this._end(i);break}},destroy:function(){if(this.options.interactive){c.removeEvent(this.indicator,"touchstart",this);c.removeEvent(this.indicator,"MSPointerDown",this);c.removeEvent(this.indicator,"mousedown",this);c.removeEvent(f,"touchmove",this);c.removeEvent(f,"MSPointerMove",this);c.removeEvent(f,"mousemove",this);c.removeEvent(f,"touchend",this);c.removeEvent(f,"MSPointerUp",this);c.removeEvent(f,"mouseup",this)}if(this.options.defaultScrollbars){this.wrapper.parentNode.removeChild(this.wrapper)}},_start:function(j){var i=j.touches?j.touches[0]:j;j.preventDefault();j.stopPropagation();this.transitionTime(0);this.initiated=true;this.moved=false;this.lastPointX=i.pageX;this.lastPointY=i.pageY;this.startTime=c.getTime();c.addEvent(f,"touchmove",this);c.addEvent(f,"MSPointerMove",this);c.addEvent(f,"mousemove",this);this.scroller._execEvent("scrollStart")},_move:function(n){var j=n.touches?n.touches[0]:n,k,i,o,m,l=c.getTime();this.moved=true;k=j.pageX-this.lastPointX;this.lastPointX=j.pageX;i=j.pageY-this.lastPointY;this.lastPointY=j.pageY;o=this.x+k;m=this.y+i;this._pos(o,m);this.scroller._execEvent("scroll");n.preventDefault();n.stopPropagation()},_end:function(k){if(!this.initiated){return}this.initiated=false;k.preventDefault();k.stopPropagation();c.removeEvent(f,"touchmove",this);c.removeEvent(f,"MSPointerMove",this);c.removeEvent(f,"mousemove",this);if(this.scroller.options.snap){var i=this.scroller._nearestSnap(this.scroller.x,this.scroller.y);var j=this.options.snapSpeed||e.max(e.max(e.min(e.abs(this.scroller.x-i.x),1000),e.min(e.abs(this.scroller.y-i.y),1000)),300);if(this.scroller.x!=i.x||this.scroller.y!=i.y){this.scroller.directionX=0;this.scroller.directionY=0;this.scroller.currentPage=i;this.scroller.scrollTo(i.x,i.y,j,this.scroller.options.bounceEasing)}}if(this.moved){this.scroller._execEvent("scrollEnd")}},transitionTime:function(i){i=i||0;this.indicatorStyle[c.style.transitionDuration]=i+"ms"},transitionTimingFunction:function(i){this.indicatorStyle[c.style.transitionTimingFunction]=i},refresh:function(){this.transitionTime(0);if(this.options.listenX&&!this.options.listenY){this.indicatorStyle.display=this.scroller.hasHorizontalScroll?"block":"none"}else{if(this.options.listenY&&!this.options.listenX){this.indicatorStyle.display=this.scroller.hasVerticalScroll?"block":"none"}else{this.indicatorStyle.display=this.scroller.hasHorizontalScroll||this.scroller.hasVerticalScroll?"block":"none"}}if(this.scroller.hasHorizontalScroll&&this.scroller.hasVerticalScroll){c.addClass(this.wrapper,"iScrollBothScrollbars");c.removeClass(this.wrapper,"iScrollLoneScrollbar");if(this.options.defaultScrollbars&&this.options.customStyle){if(this.options.listenX){this.wrapper.style.right="8px"}else{this.wrapper.style.bottom="8px"}}}else{c.removeClass(this.wrapper,"iScrollBothScrollbars");c.addClass(this.wrapper,"iScrollLoneScrollbar");if(this.options.defaultScrollbars&&this.options.customStyle){if(this.options.listenX){this.wrapper.style.right="2px"}else{this.wrapper.style.bottom="2px"}}}var i=this.wrapper.offsetHeight;if(this.options.listenX){this.wrapperWidth=this.wrapper.clientWidth;if(this.options.resize){this.indicatorWidth=e.max(e.round(this.wrapperWidth*this.wrapperWidth/(this.scroller.scrollerWidth||this.wrapperWidth||1)),8);this.indicatorStyle.width=this.indicatorWidth+"px"}else{this.indicatorWidth=this.indicator.clientWidth}this.maxPosX=this.wrapperWidth-this.indicatorWidth;this.sizeRatioX=this.options.speedRatioX||(this.scroller.maxScrollX&&(this.maxPosX/this.scroller.maxScrollX))}if(this.options.listenY){this.wrapperHeight=this.wrapper.clientHeight;if(this.options.resize){this.indicatorHeight=e.max(e.round(this.wrapperHeight*this.wrapperHeight/(this.scroller.scrollerHeight||this.wrapperHeight||1)),8);this.indicatorStyle.height=this.indicatorHeight+"px"}else{this.indicatorHeight=this.indicator.clientHeight}this.maxPosY=this.wrapperHeight-this.indicatorHeight;this.sizeRatioY=this.options.speedRatioY||(this.scroller.maxScrollY&&(this.maxPosY/this.scroller.maxScrollY))}this.updatePosition()},updatePosition:function(){var i=e.round(this.sizeRatioX*this.scroller.x)||0,j=e.round(this.sizeRatioY*this.scroller.y)||0;if(!this.options.ignoreBoundaries){if(i<0){i=0}else{if(i>this.maxPosX){i=this.maxPosX}}if(j<0){j=0}else{if(j>this.maxPosY){j=this.maxPosY}}}this.x=i;this.y=j;if(this.scroller.options.useTransform){this.indicatorStyle[c.style.transform]="translate("+i+"px,"+j+"px)"+this.scroller.translateZ}else{this.indicatorStyle.left=i+"px";this.indicatorStyle.top=j+"px"}},_pos:function(i,j){if(i<0){i=0}else{if(i>this.maxPosX){i=this.maxPosX}}if(j<0){j=0}else{if(j>this.maxPosY){j=this.maxPosY}}i=this.options.listenX?e.round(i/this.sizeRatioX):this.scroller.x;j=this.options.listenY?e.round(j/this.sizeRatioY):this.scroller.y;this.scroller.scrollTo(i,j)}};g.ease=c.ease;return g})(window,document,Math);
/*! scripts/vendor/masonry/jquery.masonry.min.js */
(function(f,b,g){var d=b.event,a;d.special.smartresize={setup:function(){b(this).bind("resize",d.special.smartresize.handler)},teardown:function(){b(this).unbind("resize",d.special.smartresize.handler)},handler:function(j,h){var k=this,i=arguments;j.type="smartresize",a&&clearTimeout(a),a=setTimeout(function(){d.dispatch.apply(k,i)},h==="execAsap"?0:100)}},b.fn.smartresize=function(h){return h?this.bind("smartresize",h):this.trigger("smartresize",["execAsap"])},b.Mason=function(h,i){this.element=b(i),this._create(h),this._init()},b.Mason.settings={isResizable:!0,isAnimated:!1,animationOptions:{queue:!1,duration:500},gutterWidth:0,isRTL:!1,isFitWidth:!1,containerStyle:{position:"relative"}},b.Mason.prototype={_filterFindBricks:function(i){var h=this.options.itemSelector;return h?i.filter(h).add(i.find(h)):i},_getBricks:function(i){var h=this._filterFindBricks(i).css({position:"absolute"}).addClass("masonry-brick");return h},_create:function(p){this.options=b.extend(!0,{},b.Mason.settings,p),this.styleQueue=[];var l=this.element[0].style;this.originalStyle={height:l.height||""};var j=this.options.containerStyle;for(var k in j){this.originalStyle[k]=l[k]||""}this.element.css(j),this.horizontalDirection=this.options.isRTL?"right":"left";var m=this.element.css("padding-"+this.horizontalDirection),h=this.element.css("padding-top");this.offset={x:m?parseInt(m,10):0,y:h?parseInt(h,10):0},this.isFluid=this.options.columnWidth&&typeof this.options.columnWidth=="function";var e=this;setTimeout(function(){e.element.addClass("masonry")},0),this.options.isResizable&&b(f).bind("smartresize.masonry",function(){e.resize()}),this.reloadItems()},_init:function(h){this._getColumns(),this._reLayout(h)},option:function(h,i){b.isPlainObject(h)&&(this.options=b.extend(!0,this.options,h))},layout:function(m,v){for(var k=0,h=m.length;k<h;k++){this._placeBrick(m[k])}var l={};l.height=Math.max.apply(Math,this.colYs);if(this.options.isFitWidth){var w=0;k=this.cols;while(--k){if(this.colYs[k]!==0){break}w++}l.width=(this.cols-w)*this.columnWidth-this.options.gutterWidth}this.styleQueue.push({$el:this.element,style:l});var j=this.isLaidOut?this.options.isAnimated?"animate":"css":"css",q=this.options.animationOptions,p;for(k=0,h=this.styleQueue.length;k<h;k++){p=this.styleQueue[k],p.$el[j](p.style,q)}this.styleQueue=[],v&&v.call(m),this.isLaidOut=!0},_getColumns:function(){var i=this.options.isFitWidth?this.element.parent():this.element,h=i.width();this.columnWidth=this.isFluid?this.options.columnWidth(h):this.options.columnWidth||this.$bricks.outerWidth(!0)||h,this.columnWidth+=this.options.gutterWidth,this.cols=Math.floor((h+this.options.gutterWidth)/this.columnWidth),this.cols=Math.max(this.cols,1)},_placeBrick:function(y){var q=b(y),j,v,D,m,C;j=Math.ceil(q.outerWidth(!0)/this.columnWidth),j=Math.min(j,this.cols);if(j===1){D=this.colYs}else{v=this.cols+1-j,D=[];for(C=0;C<v;C++){m=this.colYs.slice(C,C+j),D[C]=Math.max.apply(Math,m)}}var B=Math.min.apply(Math,D),x=0;for(var t=0,A=D.length;t<A;t++){if(D[t]===B){x=t;break}}var w={top:B+this.offset.y};w[this.horizontalDirection]=this.columnWidth*x+this.offset.x,this.styleQueue.push({$el:q,style:w});var k=B+q.outerHeight(!0),z=this.cols+1-A;for(t=0;t<z;t++){this.colYs[x+t]=k}},resize:function(){var h=this.cols;this._getColumns(),(this.isFluid||this.cols!==h)&&this._reLayout()},_reLayout:function(i){var h=this.cols;this.colYs=[];while(h--){this.colYs.push(0)}this.layout(this.$bricks,i)},reloadItems:function(){this.$bricks=this._getBricks(this.element.children())},reload:function(h){this.reloadItems(),this._init(h)},appended:function(j,h,k){if(h){this._filterFindBricks(j).css({top:this.element.height()});var i=this;setTimeout(function(){i._appended(j,k)},1)}else{this._appended(j,k)}},_appended:function(i,h){var j=this._getBricks(i);this.$bricks=this.$bricks.add(j),this.layout(j,h)},remove:function(h){this.$bricks=this.$bricks.not(h),h.remove()},destroy:function(){this.$bricks.removeClass("masonry-brick").each(function(){this.style.position="",this.style.top="",this.style.left=""});var h=this.element[0].style;for(var e in this.originalStyle){h[e]=this.originalStyle[e]}this.element.unbind(".masonry").removeClass("masonry").removeData("masonry"),b(f).unbind(".masonry")}},b.fn.imagesLoaded=function(p){function j(){p.call(t,m)}function h(i){var o=i.target;o.src!==l&&b.inArray(o,q)===-1&&(q.push(o),--k<=0&&(setTimeout(j),m.unbind(".imagesLoaded",h)))}var t=this,m=t.find("img").add(t.filter("img")),k=m.length,l="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",q=[];return k||j(),m.bind("load.imagesLoaded error.imagesLoaded",h).each(function(){var i=this.src;this.src=l,this.src=i}),t};var c=function(e){f.console&&f.console.error(e)};b.fn.masonry=function(h){if(typeof h=="string"){var i=Array.prototype.slice.call(arguments,1);this.each(function(){var e=b.data(this,"masonry");if(!e){c("cannot call methods on masonry prior to initialization; attempted to call method '"+h+"'");return}if(!b.isFunction(e[h])||h.charAt(0)==="_"){c("no such method '"+h+"' for masonry instance");return}e[h].apply(e,i)})}else{this.each(function(){var e=b.data(this,"masonry");e?(e.option(h||{}),e._init()):b.data(this,"masonry",new b.Mason(h,this))})}return this}})(window,jQuery);
/*! scripts/pagebox.js */
/*!
 * Tumblr.Pagebox
 * Create lightboxes and overlays from URLs or html fragments.
 * Features:
 *   - Easily talk from the url or html fragment using Tumblr.PageboxLink
 *   - Optional glass and loader
 *   - Lots of callbacks
 */
(function(c,b){var a=Backbone.View.extend({defaults:{has_glass:true,glass_close:true,glass_load:true,glass_color:"#000",glass_opacity:0.67,load_timeout:5000,destroy_on_close:true,post_message_scope:"*"},events:{},initialize:function(d){this.options=d||{};this.options=_.extend(this.defaults,this.options);this.callback={};this.built=false;this.visible=false;this.t_visible_timeout=null;this.t_focus_timeout=null;this.callback.on_payload=this._set_callback(this.options.on_payload);this.callback.before_show=this._set_callback(this.options.before_show);this.callback.on_show=this._set_callback(this.options.on_show);this.callback.before_hide=this._set_callback(this.options.before_hide);this.callback.on_hide=this._set_callback(this.options.on_hide);this.callback.before_destroy=this._set_callback(this.options.before_destroy);this.callback.on_destroy=this._set_callback(this.options.on_destroy);this.callback.on_error=this._set_callback(this.options.on_error);this._listen();if(this.options.glass_close){this._setup_keys()}},_set_callback:function(d){return(_.isFunction(d))?d:function(){}},open_url:function(d){if(!this._can_set()){return false}this.$iframe=c("<iframe>",{scrolling:"yes",frameborder:"0",style:"opacity:0;",src:d,"class":"ui_pagebox"});c("body").append(this.$iframe);this._finish_building()},open_html:function(){if(!this._can_set()){return false}alert("HTML fragments are not yet implemented.");this._finish_building()},change_url:function(d){this.$iframe.css({opacity:"0"});this._do_loader();this.$iframe.attr("src",d)},_can_set:function(){return(c(".ui_pagebox").length===0)},_finish_building:function(){if(this.built){return}if(this.options.has_glass){this.$glass=c("<div/>").addClass("ui_pagebox_glass");c("body").append(this.$glass);if(this.options.glass_close){this.$glass.click(_.bind(this.close,this))}this.$glass.css("background-color",this.options.glass_color);this.$glass.css("opacity",this.options.glass_opacity);this._do_loader()}c("html").css("overflow","hidden");this.built=true;this.t_visible_timeout=setTimeout(_.bind(this.callback.on_error,this),this.options.load_timeout)},_listen:function(){var d=this._listen_handler;c(window).on("message.pagebox",_.bind(d,this))},_listen_handler:function(d){var g=d.originalEvent;var h=false;var f=false;if(_.isString(g.data)){h=g.data}if(!h){return}if(h.indexOf("page_payload:")===0){f=h.substring(13);h="page_payload";if(f){try{f=JSON.parse(f)}catch(g){f=false}}}switch(h){case"close_glass":case"page_close":this.close();break;case"page_ready":this.show();break;case"page_load":break;case"page_payload":this.callback.on_payload(f);break;default:}},show:function(){if(_.isObject(this.loader)){this.loader.destroy()}clearTimeout(this.t_visible_timeout);this.callback.before_show();c("html").css("overflow","hidden");this._show_glass();this._show_iframe();this.visible=true;this.callback.on_show()},_do_loader:function(){if(!this.options.glass_load){return}var d={color:"#fff"};this.loader=new Tumblr.Loader(d);this.loader.start(this.$glass)},_show_glass:function(){if(!this.options.has_glass){return}if(_.isObject(this.$glass)){this.$glass.show()}},_show_iframe:function(){if(_.isObject(this.$iframe)){this.$iframe.css({opacity:"1"});this.t_focus_timeout=setTimeout(c.proxy(function(){this.$iframe[0].contentWindow.blur();this.$iframe[0].contentWindow.focus();this.t_focus_timeout=null},this),100)}},_setup_keys:function(){c(document).on("keydown.pagebox",_.bind(function(i){var h=i.charCode?i.charCode:i.keyCode,d=i.shiftKey,g=i.altKey,f=(i.ctrlKey||i.shiftKey||i.metaKey);if(!this.visible||f){return}if(h===27){this.close()}},this))},close:function(){this.hide();if(this.options.destroy_on_close){this.destroy()}},hide:function(){this.callback.before_hide();c("html").css("overflow","auto");if(_.isObject(this.loader)){this.loader.destroy()}if(_.isObject(this.$glass)){this.$glass.hide()}if(_.isObject(this.$iframe)){this.$iframe.css({opacity:"0"})}this.visible=false;this.callback.on_hide()},destroy:function(){this.callback.before_destroy();c(window).off("message.pagebox");c(document).off("keydown.pagebox");this.hide();if(_.isObject(this.$glass)){this.$glass.remove()}if(_.isObject(this.$iframe)){this.$iframe.remove()}if(this.t_focus_timeout){clearTimeout(this.t_focus_timeout)}this.callback.on_destroy()},test:function(){this.open_url("http://t.dev/hello_lightbox/dissap0inted/48664050807")},post_message:function(e,f){var d;if(f){d=e+":"+JSON.stringify(f)}else{d=e}this.$iframe[0].contentWindow.postMessage(d,this.options.post_message_scope)}});b.Pagebox=a})(jQuery,Tumblr);(function(c,a){var b={init:function(){c(document).ready(this._ready);c(window).load(this._load);return this},payload:function(d){var e=JSON.stringify(d);parent.postMessage("page_payload:"+e,"*")},close:function(){parent.postMessage("page_close","*")},_ready:function(){parent.postMessage("page_ready","*")},_load:function(){parent.postMessage("page_load","*")}};a.PageboxLink=b})(jQuery,Tumblr);
/*! scripts/color_utilities.js */
(function(c,b,a){var d={rgb_to_hex:function(h,f,e){return"#"+((1<<24)+(h<<16)+(f<<8)+e).toString(16).slice(1)},hex_to_rgb:function(f){f=new String(f).replace(/[^0-9a-f]/gi,"");if(f.length<6){f=f[0]+f[0]+f[1]+f[1]+f[2]+f[2]}var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(f);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null},rgb_to_hsv:function(l,k,f){var j=Math.min(Math.min(l,k),f);var e=Math.max(Math.max(l,k),f);var h=e-j;var i={h:6,s:e?((e-j)/e):0,v:(e/255)};if(!h){i.h=0}else{if(e===l){i.h+=(k-f)/h}else{if(e===k){i.h+=2+(f-l)/h}else{i.h+=4+(l-k)/h}}}i.h=(60*i.h)%360;return i},hsv_to_rgb:function(j,q,p){var e,k,n;if(!q){e=k=n=p}else{e=k=n=0;var i=((j+360)%360)/60;var l=p*q;var f=p-l;var o=l*(1-Math.abs(i%2-1));if(i<1){e=l;k=o}else{if(i<2){e=o;k=l}else{if(i<3){k=l;n=o}else{if(i<4){k=o;n=l}else{if(i<5){n=l;e=o}else{n=o;e=l}}}}}e+=f;k+=f;n+=f}return{r:Math.round(255*e),g:Math.round(255*k),b:Math.round(255*n)}},hex_to_hsv:function(g){g=new String(g).replace(/[^0-9a-f]/gi,"");if(g.length<6){g=g[0]+g[0]+g[1]+g[1]+g[2]+g[2]}var f=a.ColorUtilities.hex_to_rgb(g);var e=a.ColorUtilities.rgb_to_hsv.apply(a.ColorUtilities,b.toArray(f));return e},hsv_to_hex:function(i,g,e){var f=a.ColorUtilities.hsv_to_rgb(i,g,e);var j=a.ColorUtilities.rgb_to_hex.apply(a.ColorUtilities,b.toArray(f));return j},hex_brightness:function(i,q){i=String(i).replace(/[^0-9a-f]/gi,"");if(i.length<6){i=i[0]+i[0]+i[1]+i[1]+i[2]+i[2]}q=q||0;var o=parseInt(i,16),j=(q<0)?0:255,f=(q<0)?-(q):q,e=o>>16,m=o>>8&255,s=o&255,n,k,h;n=Math.round((j-e)*f)+e;k=Math.round((j-m)*f)+m;h=Math.round((j-s)*f)+s;return"#"+(16777216+n*65536+k*256+h).toString(16).slice(1)},hsv_to_readable:function(e){if(typeof e==="string"){e=a.ColorUtilities.hex_to_hsv(e)}return(e.s<0.2&&e.v>0.8)?"#444":"#FFF"},compare_colors:function(k,i,o){var g={upper_bound:0.8,lower_bound:0.2,diff_bound:0.1,hue_bound:15};b.extend(g,o);var j=g.upper_bound;var n=g.lower_bound;var m=g.diff_bound;var e=g.hue_bound;var h=Math.abs(k.h-i.h);var f=Math.abs(k.s-i.s);var l=Math.abs(k.v-i.v);if(h<=m&&f<=m&&l<=m){return true}else{if(f<=m&&l<=m){if(f>=j||f<=n&&l>=j||l<=n&&h<=e){return true}}}return false}};a.ColorUtilities=d})(jQuery,_,Tumblr);
/*! scripts/indash_blog/views/header/popover.js */
Tumblr.IndashBlog||(Tumblr.IndashBlog={});Tumblr.IndashBlog.Header||(Tumblr.IndashBlog.Header={});(function(d,b,e,a){var c=e.View.extend({className:"indash_header_popover",defaults:{direction:"left",edit_field:null,template:false,template_data:{},trigger:null,glassless:true},__close:function(){this.hide()},initialize:function(f){this.options=b.extend({},this.defaults,f);this.template=this.options.template;this.template_data=this.options.template_data;this.checkbox_template=b.template(d("#tumblelog_header_checkbox_template").html());this.color_picker_template=b.template(d("#tumblelog_header_color_picker_template").html());this.is_showing=false;this.$popover=null;this.popover_view=null;a.Popover.register(this)},render:function(){var f=this.template(this.template_data);this.$popover=d(f).appendTo(this.$el).hide();this.popover_view=new Tumblr.Popover({el:this.options.trigger,popover:this.$popover,glassless:this.options.glassless,glassless_options:this.options.glassless_options,auto_show:false,direction:this.options.direction,skip_offset:true,on_show:b.bind(function(){if(!this.is_showing){Tumblr.Events.trigger("indashblog:popover:show",this,this.options.edit_field);this.is_showing=true}},this),on_hide:b.bind(function(){if(this.is_showing){Tumblr.Events.trigger("indashblog:popover:hide",this,this.options.edit_field);this.is_showing=false}},this)});return this},show:function(){this.popover_view.show()},hide:function(){if(!this.is_showing){return}Tumblr.Events.trigger("indashblog:popover:hide",this,this.options.edit_field);this.is_showing=false;this.popover_view.hide()}});c.instances=[];c.register=function(f){this.instances.push(f)};c.hide_all=function(){for(var g=0,f=this.instances.length;g<f;g++){this.instances[g].hide()}};a.Popover=c})(jQuery,_,Backbone,Tumblr.IndashBlog.Header);
/*! scripts/indash_blog/views/header/info_popover.js */
Tumblr.IndashBlog||(Tumblr.IndashBlog={});Tumblr.IndashBlog.Header||(Tumblr.IndashBlog.Header={});(function(d,b,e,a){var c=a.Popover.extend({template:b.template(d("#tumblelog_header_info_popover_template").html()),defaults:{show_flag_button:true},events:{"click .ask_menu_item":"__ask_menu_item_clicked","click .fan_mail_menu_item":"__fan_mail_menu_item_clicked","click .archive_menu_item":"__archive_menu_item_clicked","click .ignore":"__ignore_click","click .block":"__block_click","click .toggle_spam":"__toggle_spam_click","click .toggle_nsfw":"__toggle_nsfw_click","click .toggle_suspended":"__toggle_suspended_click","click .panel_menu_item":"__panel_menu_item_clicked",},__panel_menu_item_clicked:function(f){this.hide()},__ask_menu_item_clicked:function(f){f.preventDefault();Tumblr.Events.trigger("indashblog:tumblelog:ask",{recipient:this.model.get("name"),anonymous_asks:this.model.get("anonymous_asks")});this.hide()},__fan_mail_menu_item_clicked:function(f){f.preventDefault();Tumblr.Events.trigger("indashblog:tumblelog:fan_mail",{recipient:this.model.get("name")});this.hide()},__archive_menu_item_clicked:function(){this.hide()},__ignore_click:function(f){f.preventDefault();if(!Tumblr.TumblelogActions){return}var g=Tumblr.TumblelogActions.confirm_ignore({tumblelog:this.model.get("name"),avatar_url:this.model.get("avatar_url")||""});this._open_dialog(g,b.bind(function(){Tumblr.ignore({tumblelog:this.model.get("name")},{success:b.bind(this._afterIgnore,this)})},this));Tumblr.Events.trigger("TumblelogPopover:navigation_menu_item_clicked");this.hide()},__block_click:function(f){f.preventDefault();Tumblr.Prima.Block.confirmBlock(this.model.get("name")).then(b.bind(this.__onBlockConfirm,this));Tumblr.Events.trigger("TumblelogPopover:navigation_menu_item_clicked");this.hide()},__onBlockConfirm:function(){var f=new Tumblr.Prima.Models.Tumblelog({name:this.model.get("name")});f.block().then(b.bind(this._afterBlock,this))},__toggle_spam_click:function(f){f.preventDefault();var g=this.model.toggle_spam();g.success(b.bind(function(h){this.model.set("spam",(h.spammer)?true:false)},this))},__toggle_nsfw_click:function(f){f.preventDefault();var g=this.model.toggle_nsfw();g.success(b.bind(function(h){this.model.set("nsfw",h.nsfw)},this))},__toggle_suspended_click:function(f){f.preventDefault();var g=this.model.toggle_suspended();g.success(b.bind(function(h){this.model.set("suspended",h.suspended)},this))},__model_change:function(){var f=this.model.toJSON();this.$(".toggle_spam").toggleClass("is_flagged",!!(f.spam));this.$(".toggle_nsfw").toggleClass("is_flagged",!!(f.nsfw));this.$(".toggle_suspended").toggleClass("is_flagged",!!(f.suspended))},_afterIgnore:function(){this.model.set("ignoring",true);this.model.set("following",false);Tumblr.PeeprLink.update_tumblelog_model(this.model.toJSON());Tumblr.PeeprLink.close()},_afterBlock:function(){this.model.set("blocking",true);this.model.set("following",false);Tumblr.PeeprLink.update_tumblelog_model(this.model.toJSON());Tumblr.PeeprLink.close()},_open_dialog:function(f,g){g=g||b.noop;this.is_disabled=true;f.fail(b.bind(function(){this.is_disabled=this.is_menu_open},this));f.done(b.bind(function(){this.is_disabled=this.is_menu_open;g()},this))},initialize:function(f){this.$trigger=f.trigger;this.targetPost=f.targetPost;if(!this.model){return}var g=this.model.toJSON();b.defaults(g,f,this.defaults);this.$popover=d(this.template(g)).appendTo(this.$el).hide();this.tumblelog=new Tumblr.Prima.Models.Tumblelog({name:this.model.get("name")});this.listenTo(this.model,"change",this.__model_change);f=b.extend(f,{popover:this.$popover});Tumblr.Popover.prototype.initialize.call(this,f)},show:function(){this.position_popover();this.listenTo(Tumblr.Events,"DOMEventor:flatresize",this.position_popover);Tumblr.Popover.prototype.show.call(this)},hide:function(){this.stopListening(Tumblr.Events,"DOMEventor:flatresize");Tumblr.Popover.prototype.hide.call(this)},position_popover:function(){var f=this.$trigger.offset().left+"px";this.$popover.css({right:"auto",left:f})}});a.InfoPopover=c})(jQuery,_,Backbone,Tumblr.IndashBlog.Header);
/*! scripts/indash_blog/views/header_view_compact.js */
var TumblrData=TumblrData||{};var Events=Tumblr.Events;Tumblr.IndashBlog||(Tumblr.IndashBlog={});(function(c,b,e,a){var d=e.View.extend({className:"indash_header_compact",defaults:{current_data:{},unfollow_data:{},follow_data:{},template_data:{},on_render:c.noop,hide_posts_on_unfollow:false,strip_description_line_breaks:false,include_info_popover:true},events:{"click .description a":"__description_link_click","click .info_popover_button":"__info_popover_button_clicked","click .follow":"__on_follow_click","click .unfollow":"__on_follow_click",'click [data-post-action="remove"]':"__on_remove_click"},__on_follow_click:function(f){f.preventDefault();f.stopPropagation();if(!Tumblr.Flags.bool("is_logged_in")){window.open("/follow/"+this.model.get("name"),"_self");return}if(this.model.get("following")){var g=Tumblr.TumblelogActions.confirm_unfollow({tumblelog:this.model.get("name"),avatar_url:this.model.get("avatar_url")||""});this._open_dialog(g,b.bind(function(){this.model.save_following({following:false},this.options.unfollow_data);if(this.hide_posts_on_unfollow){this._hide_posts()}},this))}else{this.model.save_following({following:true},this.options.follow_data)}},__on_remove_click:function(f){f.preventDefault();this.destroy()},__info_popover_button_clicked:function(f){f.preventDefault();f.stopPropagation();this.info_popover.toggle()},__description_link_click:function(i){i.preventDefault();var f=c(i.currentTarget).attr("href");try{if(Tumblr.Prima.Url&&Tumblr.Prima.Url.hasAllowedProtocol(f)){if(!Tumblr.Prima.Url.isAbsoluteUrl(f)){var h="http://"+this.model.get("name")+".tumblr.com/";f=(f.charAt(0)==="/")?f.substr(1):f;f=h+f}window.open(f,"_blank")}}catch(g){}},_render_follow_button:function(){if(this.model.get("following")){this.$el.find(".follow").hide();this.$el.find(".unfollow").show()}else{this.$el.find(".unfollow").hide();this.$el.find(".follow").show()}},_hide_posts:function(){Tumblr.Posts.whereBy({tumblelog:this.model.get("name"),sponsored:false}).invoke("dismiss")},_open_dialog:function(f,g){g=g||c.noop;this.is_disabled=true;f.fail(b.bind(function(){this.is_disabled=this.is_menu_open},this));f.done(b.bind(function(){this.is_disabled=this.is_menu_open;g()},this))},_render_inline_styles:function(){var j=this.model.get("global_theme_params");var g=!!(j.header_image_focused&&j.header_stretch&&j.show_header_image);var i=Tumblr.ColorUtilities.hex_to_hsv(j.background_color);var h=Tumblr.ColorUtilities.hex_to_hsv(j.link_color);var f=j.link_color;if(Tumblr.ColorUtilities.compare_colors(h,i)){f=Tumblr.ColorUtilities.hsv_to_readable(i)}if(!g){this.$(".navigation .nav_icon").css("color",f);this.$(".navigation .blog_name").css("color",f);this.$(".navigation .post_dismiss").css("color",f);this.$(".navigation .dismiss_icon").css("color",f);this.$(".navigation button").css({color:j.background_color,"background-color":f})}this.$(".description a").css("color",j.link_color);return this},_render_font_styles:function(){if(!Tumblr.webfonts){return}var i=this.model.get("global_theme_params");if(b.has(Tumblr.webfonts,i.title_font)){var h=b.result(Tumblr.webfonts,i.title_font);var f="webfont_"+h.path;if(h.path&&!c("head #"+f).length){var g=this.assets_host+"/fonts/"+h.path+"/stylesheet.css";g+=(b.has(h,"_v"))?("?v="+h._v):"";c("<link>",{id:f,rel:"stylesheet",type:"text/css",href:g}).appendTo(c("head"))}}},__log_recommendation_dismissal:function(){c.ajax({method:"POST",url:"/svc/search/log_dismissal",data:{tumblelog_name:this.model.get("name")},with_form_key:true})},initialize:function(f){this.options=b.extend({},this.defaults,f);this.hide_posts_on_unfollow=this.options.hide_posts_on_unfollow;this.current_data=this.options.current_data;this.on_render=this.options.on_render;this.targetPost=this.options.targetPost;this.is_rendered=false;this.assets_host=Tumblr.assets_host||"";this.template=b.template(c("#tumblelog_header_template").html());this.$description=null;this.$description_inner=null;this.listenTo(this.model,"add:global_theme_params",this.render);this.listenTo(this.model,"change:global_theme_params",this.render);this.listenTo(this.model,"change:following",this._render_follow_button);if(!b.isEmpty(this.current_data)){var g=b.extend({},this.current_data,this.model.toJSON());this.model.set(g,{silent:true})}},render:function(){var g=this.model.toJSON();g.following||(g.following=false);if(this.is_rendered||!g.global_theme_params){return this}var h=b.result(Tumblr.webfonts,g.global_theme_params.title_font);var f=Tumblr.ColorUtilities.hex_to_rgb(g.global_theme_params.title_color);this.$el.html(this.template(b.merge(g,{show_navigation:true,show_share_controls:false,show_user_controls:true,show_follow_button:true,show_dismiss_controls:false,title_font_family:false,title_font_family:(h)?h.family:false,title_color_rgb:String(b.values(f).join(","))},this.options.template_data)));this.$description=this.$(".description");this.$description_inner=this.$(".description .description_inner");this._render_font_styles();this._render_inline_styles();if(Tumblr.Flags.bool("is_logged_in")&&this.options.include_info_popover){this.info_popover=new Tumblr.TumblelogPopover.PopticaInfoPopover({el:this.$el,auto_show:false,trigger:this.$el.find(".info_popover_button"),recipient:this.model.get("name"),asks:this.model.get("asks"),anonymous_asks:this.model.get("anonymous_asks"),url:this.model.get("url"),skip_glass:true,model:this.model,targetPost:this.targetPost,show_flag_button:!Tumblr.IndashBlog.is_peepr})}this.is_rendered=true;this.on_render();if(this.$description.length){b.delay(b.bind(this.truncate_description,this),100);if(this.options.strip_description_line_breaks){this.strip_description_line_breaks()}}return this},strip_description_line_breaks:function(){this.$description_inner.find("br").remove();var f=this.$description_inner.html();var g=f.replace(/[\n\r]/g," ");this.$description_inner.html(g)},destroy:function(){this.$el.fadeOut(500,b.bind(function(){this.unbind();if(this.$el.parent().hasClass("post_container")){this.$el.parent().remove()}this.__log_recommendation_dismissal();Events.trigger("DOMEventor:updateRect");Events.trigger("posts:destroyed",this.$el);this.remove()},this))},truncate_description:function(){var i=this.$description_inner.get(0);if(i.scrollHeight<=i.clientHeight){return}var h=this.model.get("global_theme_params");var f=h.background_color;var g=Tumblr.ColorUtilities.hex_to_rgb(f);this.$description.append(this.description_gradient_template({background_color:String(b.values(g).join(","))}))},description_gradient_template:b.template('            <div class="description_gradient" style="                background: -moz-linear-gradient(top,  rgba(<%= background_color %>,0) 0%, rgba(<%= background_color %>,0.75) 50%, rgba(<%= background_color %>,1) 100%);                background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(<%= background_color %>,0)), color-stop(50%,rgba(<%= background_color %>,0.75)), color-stop(100%,rgba(<%= background_color %>,1)));                background: -webkit-linear-gradient(top,  rgba(<%= background_color %>,0) 0%,rgba(<%= background_color %>,0.75) 50%,rgba(<%= background_color %>,1) 100%);                background: -o-linear-gradient(top,  rgba(<%= background_color %>,0) 0%,rgba(<%= background_color %>,0.75) 50%,rgba(<%= background_color %>,1) 100%);                background: -ms-linear-gradient(top,  rgba(<%= background_color %>,0) 0%,rgba(<%= background_color %>,0.75) 50%,rgba(<%= background_color %>,1) 100%);                background: linear-gradient(to bottom,  rgba(<%= background_color %>,0) 0%,rgba(<%= background_color %>,0.75) 50%,rgba(<%= background_color %>,1) 100%);            "></div>        ')});a.HeaderCompact=d})(jQuery,_,Backbone,Tumblr.IndashBlog);
/*! scripts/indash_blog/indash_blog_header_compact.js */

/*! scripts/search/utils/search_autopager.js */
(function(b,a){var c=Backbone.View.extend({options:{polling:true,offset:300,buffer:0},initialize:function(d){_.extend(this.options,d);this.listenTo(Tumblr.Events,"DOMEventor:flatscroll",this.should_auto_paginate,this);this.listenTo(Tumblr.Events,"DOMEventor:flatresize",this.should_auto_paginate,this);this.listenTo(Tumblr.Events,"Autopager:stop",this.stop_polling,this);this.listenTo(Tumblr.Events,"Autopager:start",this.start_polling,this)},should_auto_paginate:function(){if(this.near_bottom()&&this.options.polling){Tumblr.Events.trigger("Autopager:trigger");this.stop_polling()}},get_buffer:function(){var d=Tumblr.Prima.DOMEventor.rect().windowHeight;if(_.isNull(d)){return false}return Math.round(d*0.666)},set_buffer:function(d){this.options.buffer=d},near_bottom:function(){this.options.buffer||(this.options.buffer=this.get_buffer());var d=Tumblr.Prima.DOMEventor.rect();var e=this.options.offset||300;if(_.isNull(d.windowScrollTop)){return false}else{var f=d.windowScrollTop+d.windowHeight-this.options.buffer;return f>-e}},stop_polling:function(){this.options.polling=false},start_polling:function(){this.options.polling=true}});a.Autopager=c})(jQuery,Tumblr);
/*! scripts/search/models/search_model.js */
(function(c,a){var d=Tumblr.Search.SearchSessionLog;function e(g,f){return function(h,i){if(h._previousAttributes[g]!=null&&h._previousAttributes[g]!==h.attributes[g]){f.apply(this,arguments)}}}var b=Backbone.Model.extend({url:function(){var f="/search/"+this.encoded_query();if(this.get("post_page")>1){f+="/post_page/"+this.get("post_page")}if(this.get("post_mode")==="web"||this.get("post_mode")==="recent"){f+="/"+this.get("post_mode")}f+=window.location.search;return f},defaults:{logged_in:!Tumblr.Flags.bool("logged_out_search"),filter_post_type:false,post_page:2,blog_page:2,filter_nsfw:Tumblr.Flags.bool("filter_nsfw"),lightbox_post:false,show_road_block:Tumblr.Flags.bool("logged_out_search")&&Tumblr.Flags.bool("search_logged_out_block"),paginations_loaded:0,has_set_paginations:false},initialize:function(){this.initially_discovery_hub=this.is_discovery_mode();this.history_api=!!(window.history&&window.history.pushState);d.set_search_model(this);this.listenTo(Tumblr.Events,"SearchModel:fetch_all",this.fetch_all,this);this.listenTo(Tumblr.Events,"SearchModel:fetch_posts",this.fetch_posts,this);this.listenTo(Tumblr.Events,"SearchModel:fetch_blogs",this.fetch_blogs,this);this.on("change:before change:blogs_before",this.on_change_before,this);this.on("change:query change:post_mode change:filter_nsfw change:filter_post_type change:filter_time_range change:post_view",this.on_change_query,this);this.on("change:post_mode",this.update_path,this);this.listenTo(Tumblr.Prima.Models.Tumblelog.collection,"change:following",e("following",this.on_follow),this);this.listenTo(Tumblr.Prima.Events,"SearchModel:setPostMode",this.setPostMode);if(this.get("show_road_block")){this.listenTo(Tumblr.Prima.Events,"Autopaginate:set_pagination",this.setPagination)}},setPostMode:function(f){this.set("post_mode",f)},on_change_before:function(f){if(this.get("before")<0){Tumblr.Events.trigger("SearchModel:fetch_posts:end")}if(_.has(f.changed,"before")){if(this.get("before")>0){this.set("post_page",this.get("post_page")+1)}else{this.set("post_page",1)}}if(this.get("blogs_before")<0){Tumblr.Events.trigger("SearchModel:fetch_blogs:end")}if(_.has(f.changed,"blogs_before")){if(this.get("blogs_before")>0){this.set("blog_page",this.get("blog_page")+1)}else{this.set("blog_page",1)}}},encode_query:function(f){return f.replace(/\s/g,"+").replace(/#/g,"%23").replace(/\?/g,"%3F").replace(/\//g,"%2F")},encoded_query:function(){return this.encode_query(this.get("query"))},decode_query:function(f){return f.replace(/\+/g," ").replace(/%23/g,"#").replace(/%3F/g,"?").replace(/%2F/g,"/")},update_path:function(){var f="/search/"+this.encode_query(this.get("query"));switch(this.get("post_mode")){case"web":case"recent":f+="/"+this.get("post_mode");break}if(this.is_discovery_mode()){f+=window.location.search}if(this.history_api){Tumblr.Prima.Events.trigger("SearchRouter:navigateTo",f,{trigger:true})}else{if(window.location.pathname!==f){window.location.href=f}}},is_discovery_mode:function(){var f=Tumblr.Flags.bool("discovery_hub_poc");var g=this.get("query").indexOf("discoveryhub")!==-1;return f&&g},on_change_query:function(g){this.set("previous_query",g.previous("query"));this.set("before",0);this.set("next_ad_offset",0);this.set("ad_placement_id",0);this.set("post_page",1);this.set("num_posts_shown",0);var f=this.is_discovery_mode()&&(g.get("previous_query")!==g.get("query"));if(_.has(g.changed,"filter_nsfw")||_.has(g.changed,"query")||f){this.set("blogs_before",0);this.set("blog_page",1);this.set("num_blogs_shown",0);this.trigger("query:change:blogs")}this.abort_updating();this.trigger("query:change:posts");this.trigger("results:refresh",g);Tumblr.Prima.Events.trigger("SearchModel:change:query",this,this.get("query"))},on_follow:function(h,f,g){g||(g={source:"SEARCH_UNKNOWN"});if(_.isBoolean(f)){var j={initiator:g.source,context:g.context,name:h.get("name"),is_follow:f};var i=["col","row"];j=_.extend(j,_.pick(g,i));Tumblr.Events.trigger("Capture:push","search_page_usage","follow",j);d.trigger("follow",j)}},should_fetch:function(){if(this.get("before")===-1){return false}else{return true}},fetch_all:function(f){if(!this.should_fetch()){return}f=_.extend({more_blogs:true,more_posts:true},f);Tumblr.Flags("search_combined_requests")(_.bind(function(){this.fetch({data:f})},this),_.bind(function(){if(f.more_blogs){this.fetch_blogs()}this.fetch_posts()},this))},setPagination:function(f){this.set("max_paginations",f.data.max_autopaginates)},fetch_posts:function(){if(!this.should_fetch()){return}this.fetch({data:{more_posts:true}})},fetch_blogs:function(){this.fetch({data:{more_blogs:true}})},fetch:function(f){if(this.get("show_road_block")&&!this.get("has_set_paginations")){Tumblr.Events.trigger("Autopaginate:check_pagination",f);this.set("has_set_paginations",true)}if(this.get("show_road_block")&&(this.get("paginations_loaded")>=this.get("max_paginations"))){return false}Tumblr.Events.trigger("SearchModel:fetch:before",f);if(f.data.more_posts){Tumblr.Events.trigger("SearchModel:fetch_posts:before",f)}if(f.data.more_blogs){Tumblr.Events.trigger("SearchModel:fetch_blogs:before",f)}f=f||{};var h={method:"POST",emulateHTTP:true,with_form_key:true,beforeSend:_.bind(this.on_before,this),success:_.bind(this.on_success,this),error:_.bind(this.on_error,this),complete:_.bind(this.on_complete,this),};var g={q:this.get("query"),sort:this.get("post_mode"),post_view:this.get("post_view"),blogs_before:this.get("blogs_before"),num_blogs_shown:this.get("num_blogs_shown"),num_posts_shown:this.get("num_posts_shown"),before:this.get("before"),blog_page:this.get("blog_page"),post_page:this.get("post_page"),filter_nsfw:this.get("filter_nsfw"),filter_post_type:this.get("filter_post_type"),filter_time_range:this.get("filter_time_range"),next_ad_offset:this.get("next_ad_offset"),ad_placement_id:this.get("ad_placement_id")};f=_.extend({},h,f);f.data=_.extend({},g,f.data);Backbone.Model.prototype.fetch.call(this,f)},log_lady_env:function(){return{q:this.get("query"),mode:this.get("post_mode"),flags:this.get("flags"),post_view:this.get("post_view"),has_blogs:this.get("has_blogs"),filter_nsfw:this.get("filter_nsfw"),filter_post_type:this.get("filter_post_type")}},generate_search_session_id:function(){return"ssid"+Tumblr.log_lady.new_uuid()},on_before:function(f){this.current_request=f},validate_res:function(m){var k=parseInt(m.getResponseHeader("X-next-offset"),10);var g=parseInt(m.getResponseHeader("X-next-blogs-offset"),10);var j=parseInt(m.getResponseHeader("X-post-page"),10);var f=parseInt(m.getResponseHeader("X-blog-page"),10);var n=parseInt(m.getResponseHeader("X-next-ad-offset"),10);var h=parseInt(m.getResponseHeader("X-ad-placement-id"),10);var l=m.getResponseHeader("X-has-blogs");var i={};if(!_.isNaN(k)){i.before=k}if(!_.isNaN(g)){i.blogs_before=g}if(!_.isNaN(j)){i.post_page=j}if(!_.isNaN(h)){i.ad_placement_id=h}if(!_.isNaN(n)){i.next_ad_offset=n}if(!_.isNaN(f)){i.blog_page=f}i.has_blogs=l;return i},on_success:function(g,h,f){this.set("paginations_loaded",this.get("paginations_loaded")+1);this.current_request=null;Tumblr.Events.trigger("SearchModel:fetch_success",g,h,f);this.set(this.validate_res(f.xhr));if(f.data.more_posts){Tumblr.Events.trigger("SearchModel:fetch_posts:success",g,h,f);Tumblr.Events.trigger("Capture:push","search_page_usage","pages");if(this.get("post_page")>2){d.trigger("page",{no:this.get("post_page")-1})}}if(f.data.more_blogs){Tumblr.Events.trigger("SearchModel:fetch_blogs:success",g,h,f);Tumblr.Events.trigger("Capture:push","search_page_usage","carousel_blog_add");d.trigger("carousel_blog_add",{no:this.get("blog_page")})}},on_error:function(g,h){var f=h.statusText;if(f!=="abort"){this.set({before:-1,blogs_before:-1,ad_placement_id:0,next_ad_offset:0})}Tumblr.Events.trigger("SearchModel:fetch_error",g,h,f)},on_complete:function(g,f){Tumblr.Events.trigger("SearchModel:fetch_complete",g,f)},abort_updating:function(){if(this.current_request){if(this.current_request.readyState!==4){this.current_request.abort()}this.current_request=null}}});a.SearchResultsModel=b})(jQuery,Tumblr);
/*! scripts/search/collections/search_tumblelogs.js */
(function(c,b){var a=Backbone.Collection.extend({model:b.Models.Tumblelog,initialize:function(){this.on("change:followed",_.bind(this.update_follow_status,this));this.listenTo(Tumblr.Events,"follow:success:tumblelog",_.bind(this.update_follow_status_by_name,this))},update_follow_status:function(d,e){var f=this.where_by({tumblelog:d.get("tumblelog")});f.invoke("set",{followed:d.get("followed")});if(d.get("followed")){f.invoke("trigger","follow:success")}else{f.invoke("trigger","unfollow:success")}},update_follow_status_by_name:function(d){var e=this.where_by({tumblelog:d});e.invoke("trigger","follow:success")},where_by:function(d){return new a(this.where(d))}});b.SearchTumblelogs=a})(jQuery,Tumblr);
/*! scripts/search/search_lightbox_controller.js */
(function(e,c,b){function a(i,h){h=h||false;var g="/search_lightbox/"+i;if(h){g+="/"+h}return g}var f=b.Search.SearchSessionLog;var d={show:function(g,k){if(!g){return}k=k||{};this.model=g;this.is_blog=k.is_blog||false;this.post_id=(this.is_blog)?k.post_id:this.model.get("id");this.tumblelog_name=(this.is_blog)?this.model.get("name"):this.model.tumblelog.get("name");if(!c.isEmpty(b.TumblelogDrawer)){var j=(this.is_blog)?this.model.get("name"):this.model.tumblelog.get("name");var i=this.post_id;var h={source:"search",blog_position:k.blog_position,path:k.context_path};b.TumblelogDrawer.open_tumblelog(j,i,!!(k.initiator==="post_masonry"),h);b.Events.once("peepr:close",this.unbind_peepr,this);b.Events.on("peepr:next",this.next_post,this);b.Events.on("peepr:previous",this.previous_post,this);b.Events.on("peepr:like_update",this.like,this);b.Events.on("peepr:reblog",this.reblog,this);return}this.pagebox=new b.Pagebox({glass_color:"#111",glass_opacity:0.92,before_show:e.proxy(function(){this.update_arrows()},this),on_payload:e.proxy(function(l){if(!l.action){return}switch(l.action){case"next":this.next_post();break;case"previous":this.previous_post();break;case"follow":this.follow(l.following,l.source);break;case"like":this.like();break;case"reblog":this.reblog();break;case"more_blog_posts":this.more_blog_posts();break}},this),before_destroy:e.proxy(this.focus,this)});if(this.is_blog){this.pagebox.open_url(a(this.model.get("name"),this.post_id))}else{this.pagebox.open_url(a(this.model.tumblelog.get("name"),this.post_id||this.model.id))}},focus:function(){if(this.is_blog){b.Events.trigger("search:bloglightbox:close",this.model.get("name"))}else{b.Events.trigger("search:lightbox:close",this.model.get("id"))}this.model=null;this.pagebox=null},unbind_peepr:function(){this.model=null;this.pagebox=null;if(b.TumblelogDrawer){c.each(["peepr:close","peepr:next","peepr:previous","peepr:like_update","peepr:reblog"],function(g){b.Events.off(g,null,this)},this)}},follow:function(g,h){var i;if(this.model instanceof b.Prima.Models.Tumblelog){i=this.model}else{if(this.model instanceof b.Post||this.model instanceof b.Prima.Models.Post){i=this.model.tumblelog}}if(i){i.save_following({following:g},{source:h})}},like:function(h,g){var i={initiator:this.is_blog?"blog_lightbox":"lightbox",post_id:g.root_id||this.post_id,blog:this.tumblelog_name,is_liked:g.liked};this.log_session_action("like",i)},reblog:function(h,g){var i={initiator:this.is_blog?"blog_lightbox":"lightbox",post_id:g.id||this.post_id,blog:this.tumblelog_name};this.log_session_action("reblog",i)},more_blog_posts:function(){this.log_session_action("more_blog_posts",{initiator:this.is_blog?"blog_lightbox":"lightbox"})},log_session_action:function(g,h){f.trigger(g,h);b.Events.trigger("Capture:push","search_page_usage",g,h)},update_arrows:function(){if(this.is_blog||!this.pagebox||!this.model||!this.model.collection){return}var g=this.model.collection.indexOf(this.model);var h={action:"update_arrows",next:!!(g<this.model.collection.length-1),previous:!!(g>0)};this.pagebox.post_message("page_payload",h)},next_post:function(){if(this.is_blog){return}var h=this.model.collection.indexOf(this.model)+1;if(h<this.model.collection.length){this.model=this.model.collection.at(h);if(!c.isEmpty(b.TumblelogDrawer)){var g=this.model.tumblelog.get("name")+"/"+this.model.id;b.TumblelogDrawer.open_page(g)}else{var i={action:"next",url:a(this.model.tumblelog.get("name"),this.model.id),data:this.model.toJSON(),at_end:!(h<this.model.collection.length-1)};this.pagebox.post_message("page_payload",i)}b.Events.trigger("search:lightbox:change",{post_id:this.model.get("id"),blog:this.model.tumblelog.get("name"),initiator:"lightbox_arrow"})}},previous_post:function(){if(this.is_blog){return}var h=this.model.collection.indexOf(this.model)-1;if(h>-1){this.model=this.model.collection.at(h);if(!c.isEmpty(b.TumblelogDrawer)){var g=this.model.tumblelog.get("name")+"/"+this.model.id;b.TumblelogDrawer.open_page(g)}else{var i={action:"previous",url:a(this.model.tumblelog.get("name"),this.model.id),data:this.model.toJSON(),at_end:!(h>0)};this.pagebox.post_message("page_payload",i)}b.Events.trigger("search:lightbox:change",{post_id:this.model.get("id"),blog:this.model.tumblelog.get("name"),initiator:"lightbox_arrow"})}}};b.SearchLightbox=d})(jQuery,_,Tumblr);
/*! scripts/prima_post_views_legacy_bridge.js */
(function(b,a){a.Events.on("tumblelogPopover:init",function(){a.Lightbox.init.apply(null,arguments)});if(a.Flags.bool("dh_should_use_postforms")){if(!a.Flags.bool("prima_post_forms")){a.PostForms.dont_touch_url=true;a.PostForms.initialize({mode:"discover"});a.Events.on("postForms:reblog",function(c){a.PostForms.edit(c.oldPostFormData)});a.Events.on("fastCompose:create",function(h){var f=h.type;if(typeof a.PostForms==="object"){var c=b("#new_post_label_"+f);var d=c.length?c.attr("href"):"/new/"+f;var g=a.PostForms.endpoints_to_types[f];var i=a.PostForms.parse_url_params(d);i.detached=true;i.loggingData=h.loggingData;a.PostForms.create({type:g,attach_to:"body",detached:true,mode:"index"},i)}else{document.location.href="/new/"+f;this.suspend()}})}}a.Events.on("sponsoredPosts:checkRings",function(){if(a.SponsoredPosts){a.SponsoredPosts.check_for_rings()}})})(jQuery,Tumblr);
/*! scripts/search/views/results/search_posts_view.js */
(function(c,b){var e=c(window);var d=Tumblr.Search.SearchSessionLog;var a=Backbone.View.extend({id:"search_posts",events:{"click [data-wai-link]":"_handle_ad_click","click [data-remnant]":"_remnant_click"},attributes:function(){return{"class":"posts posts_view_"+this.model.get("post_view"),"data-view-posts":"",}},required_controls:["filter_popover","post_layout","post_mode_control","filter_post_type_control","post_view_control","nsfw_lock_icon","filter_time_range_control"],collection:Tumblr.Posts,subviews:{},first_page:true,_handle_ad_click:function(f){Tumblr.Events.trigger("Capture:push","search_page_usage","ad_click",{source:"yahoo_grid_ad"});d.trigger("ad_click",{source:"yahoo_grid_ad"})},_remnant_click:function(f){Tumblr.Events.trigger("useraction:search_click:remnant",{loggingData:{pt:c(f.currentTarget).closest(".remnant_ad").data("pt"),userAction:"click_thru"}})},_updateLayout:function(){if(this.$masonryContainer){if(Tumblr.Flags.bool("search_carousel_align")){this.$carousel_align_parent.css("width","")}this.$masonryContainer.masonry({itemSelector:".post_brick",gutterWidth:this.gutterWidth,columnWidth:this.columnWidth,isFitWidth:true});this.get_highest_bottom_post_position();if(Tumblr.Flags.bool("search_carousel_align")){this.$carousel_align_parent.css("width",this.$masonryContainer.width())}Tumblr.Events.trigger("search:layout:updated")}},_onAfterResize:function(){this._updateLayout()},setup_ghostlist:function(){this.search_posts_gl=new Tumblr.GhostList({nonlinear:this.model.get("post_view")==="masonry",container:this.$el,pages:[1,1.5],eventor:Tumblr.Events,onBeforeDetach:function(g){var f=c(g).children(".post").first();if(f.length===0){f=c(g)}if(f.hasClass("is_audio")){return"hide"}if(f.hasClass("is_video")){return false}if(c(g).hasClass("remnant_ad")){return"hide"}return !f.hasClass("is_persistent")}})},setup_masonry:function(){this.columnWidth=300;this.gutterWidth=20;this.postWidth=this.columnWidth+this.gutterWidth;this.$masonryContainer=this.$el;if(Tumblr.Flags.bool("search_carousel_align")){this.$carousel_align_parent=this.$masonryContainer.closest(".search_results")}this.listenTo(Tumblr.Events,"DOMEventor:flatresize",_.debounce(_.bind(this._onAfterResize,this),300));this._updateLayout()},initialize:function(g){this.options=_.extend({},g);this.form_key=c("#tumblr_form_key").attr("content");this.body_class="search_results_mode_"+this.model.get("post_mode");this.$body=c("body");this.$body.addClass(this.body_class);this.is_reflow=this.options.is_reflow||false;this.listenTo(Tumblr.Events,"posts:load",this.create_posts,this);this.listenTo(Tumblr.Events,"search:lightbox:change",this.scroll_to_post,this);this.listenTo(Tumblr.Events,"search:lightbox:change",this.lightbox_post_view,this);this.listenTo(Tumblr.Events,"search:lightbox:close",this.focus_post,this);this.listenTo(Tumblr.Events,"search:post:photo_expanded",this._updateLayout,this);this.listenTo(Tumblr.Events,"posts:destroyed",this._updateLayout);this.listenTo(Tumblr.Events,"posts:change:text_size",this._updateLayout);this.setup_ghostlist();this.disable_keycommands();if(!Tumblr.Flags("dashboard_refresh")){this.subviews.elevator=new Tumblr.Elevator()}if(Tumblr.Flags.bool("search_results_scroll_logging")){var f=_(this._log_scroll_y).bind(this).throttle(1000,{leading:false}).value();this.listenTo(Tumblr.Events,"DOMEventor:flatscroll",f)}this.create_posts();if(this.model.get("post_view")==="list"){this.enable_keycommands()}else{Tumblr.Flags("search_results_redesign")(_.bind(function(){this.setup_masonry()},this))}},_log_scroll_y:function(f){d.trigger("search_scroll",{document_height:f.documentHeight,window_scroll_top:f.windowScrollTop,columns:this.get_columns(),num_posts:this.collection.length})},enable_keycommands:function(){if(_.isObject(Tumblr.KeyCommands)){Tumblr.KeyCommands.resume()}},disable_keycommands:function(){if(_.isObject(Tumblr.KeyCommands)){Tumblr.KeyCommands.suspend()}},render:function(){if(this.model.get("lightbox_post")){var f;var g=this.model.get("lightbox_post");this.scroll_to_post(g);this.focus_post(g.post_id);f=this.subviews[g.post_id];Tumblr.Events.trigger("search:lightbox:raised");f.lightbox_pop(new Event("null"),"search_redirect")}return this},lightbox_post_view:function(f){Tumblr.Events.trigger("Capture:push","search_page_usage","lightbox",f);d.trigger("lightbox",f)},_remove_subviews:function(){_.each(this.subviews,function(f){f.remove()});this.collection.reset()},remove:function(){this.removed=true;this.$body.removeClass(this.body_class);this._remove_subviews();if(this.search_posts_gl){this.search_posts_gl.remove()}Backbone.View.prototype.remove.call(this)},load_images:function(){var g=this.$(".search_posts_row").not("[data-images-loaded]");var f=g.find("[data-background-image]");if(this.first_page){g.slice(0,4).addClass("in_view")}this.first_page=false;g.attr("data-images-loaded","");_.each(f,function(j){var i=j.getAttribute("data-background-image");j.style.opacity=0;var h=new Image();h.src=i;j.style.backgroundImage="url("+i+")";h.onload=function(){j.style.opacity=1;j.removeAttribute("data-background-image")};h=null})},create_post:function(h,k){var n=c(h);var p=n.find("[data-tumblelog-popover]").data("tumblelog-popover");var l=n.data();if(typeof(p)!=="object"){p={};if(Tumblr.Flags.bool("is_dev")){console.warn("Unable to find popover data for "+l.tumblelogName)}}var o;if(Tumblr.Flags.bool("prima_post_model")||Tumblr.Flags.bool("search_prima_post_views")){o=new Tumblr.Prima.Models.Post(n.data("json"))}else{_.defaults(p,{following:false,name:l.tumblelogName});var g={id:l.postId,type:l.type,root_id:l.rootId,tumblelog:l.tumblelogName,tumblelog_key:l.tumblelogKey,"tumblelog-data":l.tumblelogData,"tumblelog-parent-data":l.tumblelogParentData,"tumblelog-root-data":l.tumblelogRootData,reblog_key:l.reblogKey,is_mine:n.hasClass("is_mine"),is_animated:l.isAnimated||false,accepts_answers:l.acceptsAnswers,orientation:l.orientation||false,reblog_source:"POST_CONTEXT_SEARCH_RESULTS_PAGE",reblogged:false,liked:n.find(".post_control.like").hasClass("liked")||false,form_key:this.form_key,sponsored:l.sponsored||false,featured_tags:(l.featuredTags||"").split(","),tumblelog_data:p,pt:l.pt,"serve-id":l.serveId};o=new Tumblr.Post(g)}var m;if(this.model.get("post_view")==="masonry"){if(Tumblr.Flags.bool("search_prima_post_views")){m=Tumblr.Prima.PostViewBuilder(o,{el:n})}else{m=new Tumblr.SearchPostMasonryView({el:n,model:o});m.$("p > .toggle_inline_image, figure > img:not(.inline_external_image)").each(function(i,q){c(q).addClass("toggle_inline_image").wrap(c('<div class="image_wrapper"></div>'))})}}else{m=new Tumblr.SearchPostListView({el:n,model:o})}if(Tumblr.Prima&&Tumblr.Prima.Events&&(o.get("type")==="video")){var f=n.find("video[data-crt-video]");if(f.length){var j=true;if(this.model.get("post_view")==="masonry"){j=false}Tumblr.Prima.Events.trigger("CrtControl:newPlayer",f,{attributes:{autoplay:j}})}}m.search_post_view="post_"+this.model.get("post_view");this.collection.add(o);this.subviews[o.get("id")]=m;n.attr("data-view-exists",true);n.removeClass("post_fade");this.model.set("num_posts_shown",this.model.get("num_posts_shown")+1);return m},append_post_html:function(g){if(!g){return}if(Tumblr.Flags.bool("search_results_redesign")&&this.model.get("post_view")!=="list"){var f=c(g).filter(".post_brick");if(Tumblr.Flags.bool("search_no_imageload_waiting")){this.$masonryContainer.append(f);this.create_posts();this.$masonryContainer.masonry("appended",f);this.get_highest_bottom_post_position()}else{this.$masonryContainer.imagesLoaded(_.bind(function(){if(this.removed){return}this.$masonryContainer.append(f);this.create_posts();this.$masonryContainer.masonry("appended",f);this.get_highest_bottom_post_position()},this))}if(this.is_reflow){this._updateLayout();this.is_reflow=false}}else{this.$el.append(g);this.load_images();this.create_posts();this.get_highest_bottom_post_position()}Tumblr.AutoPaginator.flushQueue()},create_posts:function(){var f=_.map(this.$(".post:not(.new_post_buttons):not([data-view-exists])"),this.create_post,this);_.each(this.$(".remnant_ad:not([data-view-exists])"),this.fade_in_ad,this);if(this.$(".remnant_ad").length&&Tumblr.SponsoredPosts){Tumblr.SponsoredPosts.check_for_rings()}Tumblr.Events.trigger("SearchView:addPostsBatch",f);_(f).filter("attachedToDOM").invoke("attachedToDOM");Tumblr.SearchLightbox.update_arrows()},fade_in_ad:function(h,g){var f=c(h);f.removeClass("post_fade")},scroll_to_post:function(h){var g=this.$el.find(".post[data-post-id="+h.post_id+"]");if(!g.length){return}var f=g.offset().top-(e.height()*0.5)+(g.outerHeight()*0.5);c("html, body").stop(true,true).animate({scrollTop:f})},focus_post:function(g){var f=this.$el.find(".post[data-post-id="+g+"]");if(!f.length){return}var h=c("<div>",{id:"post_focus_glass"});if(Tumblr.TumblelogDrawer){h.addClass("blue")}this.$el.append(h);f.addClass("focus");h.delay(200).fadeOut(500,function(){h.remove();f.removeClass("focus")})},get_columns:function(){var g=this.$el.width();var f=300;this.columns=Math.floor(g/f);return this.columns},get_highest_bottom_post_position:function(){this.get_columns();var k=this.columns;var m=Number.MAX_VALUE;var i={};var j=this.$el.children();var f=j.length-1;while(k&&f>=0){var h=j.eq(f);var l=h.offset();if(!i[l.left]){--k;i[l.left]=true;var g=l.top+h.height();m=Math.min(m,g)}--f}Tumblr.Events.trigger("search:results:last_row_updated",m)}});b.SearchPostsView=a})(jQuery,Tumblr);
/*! scripts/search/views/posts/base_post.js */
(function(d,c){var a=!Tumblr.Flags.bool("is_logged_in");var b=Tumblr.PostView.extend({events:{"click .post_control.like:not(.liked)":"search_like","click .post_control.liked":"search_unlike","click .post_control.reblog":"search_reblog","click .post_control.reply":"reply","click .post_control.block":"ignore","click .reblog_follow_button":"follow","click .post_tag":"click_tag","click .icon.icon_flag":"flag","click .post_media":"media_click","click .post_body a":"caption_click","click .post_permalink":"permalink_click","click .note_count":"notes_click","click .note .follow":"note_follow"},initialize:function(){Tumblr.PostView.prototype.initialize.apply(this,arguments);this.follow_toggle=this.$el.find(".reblog_follow_button");this.postModerationPopover=null;this.tumblelog=this.model.tumblelog||(this.model.tumblelog=new Tumblr.Prima.Models.Tumblelog(this.model.get("tumblelog_data")));this.listenTo(this.tumblelog,"change:following",this.follow_success);this.listenTo(Tumblr.Events,"flagged:"+this.tumblelog.get("name"),this.on_flagged);_.result(this,"after_initialize");if(scrollMonitor&&Tumblr.Flags.bool("search_post_impression_logging")){this.scrollMonitor=scrollMonitor.create(this.$el,-(this.$el.height()/2));this.scrollMonitor.enterViewport(_.bind(this.onViewportEnter,this))}},onViewportEnter:function(g){var f={loggingData:{id:this.model.get("id"),tumblelog:this.model.get("tumblelog")}};Tumblr.Events.trigger("search:post:impression",f);this.scrollMonitor.destroy()},on_flagged:function(f){this.$el.addClass("is_flagged")},search_like:function(i){if(a){var g=(document.location.pathname+"/post/"+this.model.get("tumblelog")+"/"+this.model.get("id"));var f=d(i.currentTarget);var h=f.attr("href");f.attr("href",g);this.logged_out_post_action(i,"like");f.attr("href",h);return}this.capture_event("like");return this.like(i)},search_unlike:function(f){if(a){return}this.capture_event("unlike");return this.unlike(f)},search_reblog:function(f){if(a){this.logged_out_post_action(f,"reblog");return}this.capture_event("reblog");return this.reblog(f)},follow:function(e){e.preventDefault();var f="FOLLOW_SOURCE_UNKNOWN";if(this.search_post_view==="post_list"){f="FOLLOW_SOURCE_SEARCH_RESULTS_POSTS_LIST"}else{if(this.search_post_view==="post_masonry"){f="FOLLOW_SOURCE_SEARCH_RESULTS_POSTS_GRID"}}this.tumblelog.save_following({following:true},{source:f,pt:this.model.get("pt")})},follow_success:function(e){if(!e.changed){return}if(e.changed.following){this.follow_toggle.addClass("active").addClass("animated").addClass("poof");window.setTimeout(_.bind(function(){this.follow_toggle.addClass("final_state")},this),1000)}else{this.follow_toggle.removeClass("active animated poof final_state")}},click_tag:function(g){g.preventDefault();var f=d(g.target).text();if(f[0]==="#"){f=f.substring(1,f.length)}Tumblr.Events.trigger("search:change:query",f);Tumblr.Events.trigger("search:submit");this.capture_event("tag_click")},logged_out_post_action:function(h,g){if(h){h.preventDefault();h.stopPropagation()}var f=d(h.currentTarget).attr("href")||document.location.pathname;this.show_login_lightbox({action:g,capture:{context:"search_page_usage"},url_params:{redirect_to:f}})},show_login_lightbox:function(e){this.loginSignupLightbox=new Tumblr.LoginSignupLightbox(e);d("body").append(this.loginSignupLightbox.render().el)},_generic_event_data:function(){var e={};_.extend(e,_.result(this,"position"));e.post_id=this.model.get("id");e.blog=this.tumblelog.get("name");e.initiator=this.search_post_view;return e},capture_event:function(e,f){f||(f={});f=_.extend(this._generic_event_data(),f);this.ads_team_logging(e,f);Tumblr.Events.trigger("Capture:push","search_page_usage",e,f);Tumblr.Search.SearchSessionLog.trigger(e,f)},ads_team_logging:function(e,f){if(this.ads_should_track_event(e)){Tumblr.Events.trigger("useraction:search_click:"+e,this.ads_prep_loggingData(e,f))}},ads_should_track_event:function(e){return !!this.model.get("pt")},ads_prep_loggingData:function(e,f){return{oldData:f,loggingData:{postData:this.model.toJSON(),userAction:e}}},flag:function(g){if(Tumblr.Flags.bool("abuse_forms")){Tumblr.Events.trigger("abuseform:open",{post:this.model})}else{var f=d(g.currentTarget);if(!this.postModerationPopover){this.postModerationPopover=new Tumblr.Prima.PostModerationPopover({post:this.model,pinnedTarget:f})}this.postModerationPopover.render()}},lightbox_pop:function(f,g){if(Tumblr.Flags.bool("is_mobile")){return}g||(g="post_grid");f&&f.preventDefault();var e=f?d(f.target).closest("[data-context-path]").data("context-path"):null;var h={blog:this.tumblelog.get("name"),initiator:g,context_path:e};this.lightbox_post_view(h);Tumblr.SearchLightbox.show(this.model,h)},lightbox_post_view:function(e){this.capture_event("lightbox",e)},permalink_click:function(){this.ads_team_logging("permalink",this._generic_event_data())},caption_click:function(f){this.ads_team_logging("caption",this._generic_event_data())},media_click:function(g){var f=this.model.get("type");if(f==="photo"||f==="photoset"){this.ads_team_logging("media",this._generic_event_data())}},notes_click:function(){this.ads_team_logging("notes",this._generic_event_data())},note_follow:function(j){j.preventDefault();var i="FOLLOW_SOURCE_SEARCH_NOTES_POPOVER";var g=d(j.currentTarget);var f=g.closest(".note");var k=f.data("tumblelog");if(!k){return}if(a){window.open("/follow/"+k);return}var h=new Tumblr.Prima.Models.Tumblelog({name:k});f.addClass("is_following");h.save_following({following:true},{source:i}).fail(function(){Tumblr.Dialog.alert(l10n_str.ajax_error)});this.capture_event("follow",{initiator:i,blog:k})}});c.SearchBasePostView=b})(jQuery,Tumblr);
/*! scripts/search/views/posts/list_post.js */
(function(c,b){var a=Tumblr.SearchBasePostView.extend({row_num:function(){var d=this.$el.closest(".post_container").index();this.row_num=d;return d},position:function(){var d=_.result(this,"row_num");return{col:0,row:d,col_count:1,type:"list"}}});b.SearchPostListView=a})(jQuery,Tumblr);
/*! scripts/search/views/posts/masonry_post.js */
(function(b,a){var c=Tumblr.SearchBasePostView.extend({events:_.extend({},Tumblr.SearchBasePostView.prototype.events,{"mouseenter .photoset_photos":"cycle_photoset","mouseleave .photoset_photos":"stop_cycle_photoset","click .expand":"__expand_clicked","click .photoset_photos":"__photoset_clicked","click .photoset_count":"__photoset_clicked","click .post_media[data-lightbox]":"__photo_clicked","click .video_poster":"toggle_video_player","click .post_header .tumblelog_info":"__header_url_clicked","click .reblog_follow_button":"follow"}),initialize:function(d){this.options=_.defaults(d,this.defaults);this.base_log_data={is_blog:false,initiator:"post_masonry",post_id:this.model.get("id")};this.listenTo(Tumblr.Events,"search:layout:updated",this._on_layout_update);Tumblr.SearchBasePostView.prototype.initialize.call(this,this.options)},follow:function(d){if(!Tumblr.Flags.bool("is_logged_in")){return}Tumblr.SearchBasePostView.prototype.follow.apply(this,arguments)},cycle_photoset:function(d){if(!_.isNumber(d)){d=1300}if(!this._photoset_cycle_rate){this.show_next_photoset_photo()}this._photoset_cycle_rate=d;this.$photoset().css("background-color","#000");this._photoset_cycle_timeout=setTimeout(_.bind(function(){this.show_next_photoset_photo();this.cycle_photoset()},this),this._photoset_cycle_rate)},show_next_photoset_photo:function(){var d=this.$shown().next();if(!d.length){d=this.$photoset().find(".photoset_photo:first")}this.$shown().removeClass("shown");d.addClass("shown");this._$shown=d},stop_cycle_photoset:function(){clearTimeout(this._photoset_cycle_timeout);this._photoset_cycle_rate=false;this.$photoset().css("background-color","")},"$photoset":function(){if(!("_$photoset" in this)){this._$photoset=this.$(".photoset_photos")}return this._$photoset},"$shown":function(){if(!(this._$shown&&this._$shown.length)){this._$shown=this.$photoset().find(".photoset_photo.shown")}if(!(this._$shown&&this._$shown.length)){this._$shown=this.$photoset().find(".photoset_photo:last").addClass("shown")}return this._$shown},__photoset_clicked:function(f){var h=this.$shown().data("lightbox");var g=_.collect(this.$photoset().find("[data-lightbox]"),function(e){return b(e).data("lightbox")});var d=_.indexOf(g,h);Tumblr.Lightbox.init(g,d+1);this.stop_cycle_photoset();this.capture_event("photo_lightbox",this.base_log_data)},__photo_clicked:function(f){var d=b(f.currentTarget).data("lightbox");if(d){Tumblr.Lightbox.init([d]);this.capture_event("photo_lightbox",this.base_log_data)}},__expand_clicked:function(d){this.expand_photo()},toggle_video_player:function(g){var f=this.$(".video_embed");var h=f.data("render-context");var d=this.$("script.embed_source");if(h==="blank"){window.open(f.data("post-url"));return}if(d.length){b(g.currentTarget).hide();d.parent().html(d.html())}},expand_photo:function(){var e=this.$el.find(".post_media.truncated");var d=e.find("img.photo");var f=50;var g=_.bind(function(){Tumblr.Events.trigger("search:post:photo_expanded",this.$el)},this);this.$el.find(".expand").remove();e.removeClass("truncated");e.velocity({"max-height":d.attr("height")},f,g);if(this.scrollMonitor){this.scrollMonitor.recalculateSize()}},__header_url_clicked:function(d){d.preventDefault();d.stopPropagation();this.lightbox_pop(d,"post_masonry")}});a.SearchPostMasonryView=c})(jQuery,Tumblr);
/*! scripts/search/views/blogs/tumblelogs.js */
(function(c,a){a.Search||(a.Search={});var b=Backbone.View.extend({use_indash_tumblelogs:a.Flags.bool("search_indash_blog_cards"),className:"blogs_wrapper_carousel_inner",attributes:{"data-view-tumblelogs":""},subviews:[],initialize:function(){if(this.use_indash_tumblelogs){this.listenTo(a.Events,"SearchModel:fetch_blogs:success",this.parse_indash_blog_data)}else{this.listenTo(a.Events,"SearchModel:fetch_blogs:success",this.parse_blog_data)}this.listenTo(a.Events,"search:bloglightbox:close",this.focus_tumblelog,this)},render:function(){if(this.use_indash_tumblelogs){this.create_indash_tumblelogs()}else{this.create_tumblelogs()}return this},parse_blog_data:function(e,g,d){var f=g.response;if(f.blogs_html&&f.blogs_html.length){this.$el.append(f.blogs_html);this.create_tumblelogs();a.Events.trigger("SearchTumblelogs:append:after")}},parse_indash_blog_data:function(e,g,d){var f=g.response;if(f.blogs_html&&f.blogs_html.length){this.$el.append(f.blogs_html);this.create_indash_tumblelogs();a.Events.trigger("SearchTumblelogs:append:after")}},create_tumblelogs:function(){var d=_.map(this.$el.find(".tumblelog_compact:not([data-view-exists])"),this.create_tumblelog,this);a.Events.trigger("SearchTumblelogs:add:batch",d)},create_indash_tumblelogs:function(){var f=c(".tumblelogs_json");var e=f.data("search-tumblelogs-json");f.remove();var d=_.map(e,this.create_indash_tumblelog,this);a.Events.trigger("SearchTumblelogs:add:batch",d)},create_indash_tumblelog:function(d,h){var f=new a.Prima.Models.Tumblelog(d);var e=new a.Search.indashTumblelogCompactView({model:f,include_posts:true,follow_data:{col:this.subviews.length,row:0,pt:f.get("pt")||""},unfollow_data:{col:this.subviews.length,row:0},blog_position:h});var g=e.render().el;c(".search_blogs_row").last().append(g);e.$el.attr("data-view-exists",true);e.$el.attr("data-tumblelog-url",f.get("url"));this.subviews.push(e);this.collection.add(f);a.Events.trigger("SearchTumblelogs:add",e);return e},create_tumblelog:function(g,f){var e=c(g);var d=new a.Prima.Models.Tumblelog({name:e.data("tumblelog-name").toString(),following:e.find(".tumblelog_follow_toggle").hasClass("followed")});this.subviews[f]=new a.Search.tumblelogCompactView({model:d,el:g});e.attr("data-view-exists",true);this.collection.add(d);a.Events.trigger("SearchTumblelogs:add",this.subviews[f]);return this.subviews[f]},clear_tumblelogs:function(){_.each(this.subviews,function(d){d.remove()})},focus_tumblelog:function(f){var e=this.$el.find(".tumblelog_compact[data-tumblelog-name="+f+"]");if(!e.length){return}e.addClass("focus");var d=c("<div>",{id:"post_focus_glass"}).appendTo(this.$el);d.delay(200).fadeOut(500,function(){d.remove();e.removeClass("focus")})}});a.Search.tumblelogsView=b})(jQuery,Tumblr);
/*! scripts/search/views/blogs/tumblelog_compact.js */
(function(c,a){a.Search||(a.Search={});var d=a.Search.SearchSessionLog;var b=Backbone.View.extend({events:{"click .tumblelog_follow_toggle":"__click_follow_toggle","click .post_micro":"lightbox_pop","click .tumblelog_compact_avatar_anchor":"lightbox_pop","click .tumblelog_compact_name":"lightbox_pop"},__click_follow_toggle:function(i){if(!a.Flags.bool("is_logged_in")){return}i.preventDefault();var f=true;var h="FOLLOW_SOURCE_SEARCH_RESULTS_BLOG_CAROUSEL";if(this.model.get("following")||this.follow_toggle.hasClass("followed")){f=false;h="UNFOLLOW_SOURCE_SEARCH_RESULTS_BLOG_CAROUSEL"}var g=this.$el.closest("[data-view-tumblelogs]").find(".tumblelog_compact");this.model.save_following({following:f},{source:h,col:g.index(this.el),row:0})},_toggle_follow:function(){if(this.model.get("following")){this.follow_toggle.addClass("followed")}else{this.follow_toggle.removeClass("followed")}},initialize:function(){this.follow_toggle=this.$(".tumblelog_follow_toggle");this.listenTo(this.model,"change:following",this._toggle_follow,this)},lightbox_pop:function(g){g.preventDefault();var e=c(g.currentTarget).attr("data-post-id");var f={is_blog:true,post_id:e,initiator:"tumblelog_compact"};a.Events.trigger("Capture:push","search_page_usage","lightbox",f);d.trigger("lightbox",f);a.SearchLightbox.show(this.model,f)}});a.Search.tumblelogCompactView=b})(jQuery,Tumblr);
/*! scripts/search/views/blogs/indash_tumblelog_compact.js */
(function(b,a){a.Search||(a.Search={});var c=a.IndashBlog.HeaderCompact.extend({className:"indash_blog indash_tumblelog_compact",events:function(){return _.extend({},a.IndashBlog.HeaderCompact.prototype.events,{"click .indash_header_wrapper .customize_button":"__on_customize_click","click .indash_header_wrapper":"_on_blog_click"})},subviews:[],defaults:{follow_data:{source:"FOLLOW_SOURCE_SEARCH_RESULTS_BLOG_CAROUSEL"},unfollow_data:{source:"UNFOLLOW_SOURCE_SEARCH_RESULTS_BLOG_CAROUSEL"},hide_posts_on_unfollow:false,include_posts:false,template_data:{show_navigation:true,show_user_controls:a.Flags.bool("is_logged_in"),show_share_controls:false,show_follow_button:true,popover:false},strip_description_line_breaks:true,fade_in:true,include_info_popover:true},initialize:function(d){this.options=_.defaults({},d,this.defaults);this.options.follow_data.source=this.defaults.follow_data.source;this.options.unfollow_data.source=this.defaults.unfollow_data.source;this.options.on_render=_.bind(this._setup_posts,this);if(this.options.fade_in){this.$el.addClass("hidden fade_in")}a.IndashBlog.HeaderCompact.prototype.initialize.call(this,this.options)},render:function(){setTimeout(_.bind(function(){this.$el.removeClass("hidden")},this),100);a.IndashBlog.HeaderCompact.prototype.render.call(this);return this},_on_blog_click:function(k){if(b(k.target).closest(".indash_header_wrapper .navigation").length){return}k.preventDefault();var i="blog_carousel";var f=b(k.target).parents(".post").data("post-id");var h=this.model.get("name");var j=this.options.blog_position;var d=b(k.target).closest("[data-context-path]").data("context-path");if(f){i+="_post"}var g={is_blog:true,blog_name:h,initiator:i,blog_position:j,post_id:f,context_path:d};if(a.Search.SearchSessionLog){a.Search.SearchSessionLog.trigger("lightbox",g)}if(a.SearchLightbox){a.SearchLightbox.show(this.model,g)}a.Events.trigger("search:blog:click:posts_click",this.ads_generate_payload("posts"));a.Events.trigger("Capture:push","search_page_usage","lightbox",g)},ads_generate_payload:function(d){return{loggingData:{postData:{"serve-id":this.model.get("pt"),pt:this.model.get("pt")},userAction:d}}},show_posts:function(){if(this.$(".recent_posts")){this.$el.addClass("show_posts")}},hide_posts:function(){this.$el.removeClass("show_posts")},_setup_posts:function(){this.subviews.highlighted_posts=new a.TumblelogPopover.Posts({model:this.model,on_bottom:true,parent:this.$el.find(".indash_header_wrapper")})},__on_customize_click:function(g){var f=b(g.currentTarget);var d=f.data("url");if(d){g.preventDefault();g.stopPropagation();window.open(d)}}});a.Search.indashTumblelogCompactView=c})(jQuery,Tumblr);
/*! scripts/search/views/blogs/tumblelog_compact_placeholder.js */
(function(c,a){a.Search||(a.Search={});var b=Backbone.View.extend({use_indash_tumblelogs:a.Flags.bool("search_indash_blog_cards"),className:"tumblelog_placeholders",initialize:function(){var d=this.use_indash_tumblelogs?"tmpl_indash_tumblelog_placeholder":"tmpl_tumblelog_placeholder";this.template=_.template(c("#"+d).html())},render:function(){this.$el.html(this.template());return this},show:function(d){if(!d.left){return}this.el.style.left=d.left+"px";this.set_opacity(1);this.el.classList.add("animated")},hide:function(){_.delay(_.bind(this.set_opacity,this),1000,0);this.el.classList.remove("animated")},set_opacity:function(d){this.el.style.opacity=d}});a.Search.tumblelogCompactPlaceholder=b})(jQuery,Tumblr);
/*! scripts/search/views/blogs/tumblelogs_carousel.js */
(function(c,a){a.Search||(a.Search={});var b=Backbone.View.extend({use_indash_tumblelogs:a.Flags.bool("search_indash_blog_cards"),options:{blogs_per_page:10,blog_width:295,blog_margin:15,selectors:{scroller:".blogs_wrapper_carousel",slide_wrapper:".blogs_wrapper_carousel_inner",slides:".tumblelog_compact",pages:".search_blogs_row",left_mask:"[data-bss-mask-left]",right_mask:"[data-bss-mask-right]",controls:"[data-bss-control]"}},indash_blog_options:{blog_width:320,blog_margin:20,selectors:{scroller:".blogs_wrapper_carousel",slide_wrapper:".blogs_wrapper_carousel_inner",slides:".indash_tumblelog_compact",pages:".search_blogs_row",left_mask:"[data-bss-mask-left]",right_mask:"[data-bss-mask-right]",controls:"[data-bss-control]"}},defaults:{subviews:{},page_count:0,current_page:0,scroll_left:0,slide_count:0,new_page_left:0,fetching:false,complete:false,_cache:{left_blog_index:false,right_blog_index:false,scroll_left:0},snapping:false,snap_speed:200,scroll_speed:500,controls_clicked:false},_last_impressed_blog_index:0,_max_impressed_blog_index:0,initialize:function(d){if(this.use_indash_tumblelogs){_.extend(this.options,this.indash_blog_options)}_.defaults(this,this.options,d);_.defaults(this,this.defaults)},render:function(){this.listenTo(a.Events,"DOMEventor:flatresize",_.debounce(this._on_resize,200),this);this.listenTo(a.Events,"SearchModel:fetch_blogs:before",this.pre_fetch,this);this.listenTo(a.Events,"SearchTumblelogs:append:after",this.post_fetch,this);this.listenTo(a.Events,"SearchModel:fetch_blogs:end",this.no_more_blogs,this);if(this.template){this.$el.append(this.template)}this.$el.on("click",this.selectors.controls,_.bind(this._on_click_controls,this));this.tumblelogs_collection=new a.SearchTumblelogs();this._create_subviews();this._refresh();this.start_iscroll();return this},_create_subviews:function(){var d=this.$("[data-view-tumblelogs]");this.subviews.tumblelogs=new a.Search.tumblelogsView({collection:this.tumblelogs_collection});if(d[0]){this.subviews.tumblelogs.setElement(d).render()}else{this.$(this.selectors.scroller).prepend(this.subviews.tumblelogs.render().el)}this.subviews.placeholder=new a.Search.tumblelogCompactPlaceholder();this.$(this.selectors.slide_wrapper).append(this.subviews.placeholder.render().el)},_remove_subviews:function(){this.subviews.placeholder.remove();this.subviews.tumblelogs.remove();this.tumblelogs_collection.reset();if(this.iScroll){this.iScroll.destroy()}},_cache_selectors:function(){this.$slides=this.$(this.selectors.slides);this.$scroller=this.$(this.selectors.scroller);this.$slide_wrapper=this.$(this.selectors.slide_wrapper);this.$pages=this.$(this.selectors.pages);this.$left_mask=this.$(this.selectors.left_mask);this.$right_mask=this.$(this.selectors.right_mask);this.$left_mask_fader=this.$left_mask.find("[data-bss-mask-fader]");this.$right_mask_fader=this.$right_mask.find("[data-bss-mask-fader]");this.slide_count=this.$slides.length;this.page_count=this.$pages.length;this.scroller_width=this.$slide_wrapper.width()},_refresh:function(d){this._cache_selectors();d=d?d:this.$slides;this._set_rect();this.get_outer_blogs();this.cache_current_blogs();this.position_slides(d);this.detach_blogs();this.blog_fader();this.toggle_control_visibility()},start_iscroll:function(){var d=(this.page_count===1&&(this.$pages.eq(0).width()<this.rect.containerWidth));var e=!("addEventListener" in document);if(d){this.el.classList.add("no_scroll");return}if(e){this.el.classList.add("natural_scroll");return}this.scroller_width=(this.blog_width*(this.slide_count+2))-this.blog_margin;this.$slide_wrapper[0].style.width=this.scroller_width+"px";this.iScroll=new IScroll(this.$scroller[0],{startX:0,startY:0,scrollX:true,scrollY:false,directionLockThreshold:5,freeScroll:false,mouseWheel:true,momentum:true,eventPassthrough:true,probeType:3,scrollbars:"custom",interactiveScrollbars:true,reverseHorizontalScroll:false});this.iScroll.on("scroll",_.bind(this._on_scroll,this));this.iScroll.on("scrollEnd",_.bind(this._on_scroll_end,this))},_get_iscroll_x:function(){return this.iScroll?(this.iScroll.x*-1):0},_set_rect:function(){if(_.isNull(a.Prima.DOMEventor.rect().documentHeight)){a.Events.trigger("DOMEventor:updateRect")}this.rect=_.clone(a.Prima.DOMEventor.rect());this.rect.containerWidth=this.$el.width();this.rect.buffer=Math.round(this.rect.containerWidth*0.666)},_on_resize:function(d){this._refresh()},_on_click_controls:function(h){h.preventDefault();h.stopPropagation();this.controls_clicked=true;var f=c(h.currentTarget).data();var g;var d;switch(f.bssControl){case"left":d=this.left_blog_index-3;if(d<0){d=0;g=this.$slides.eq(0)[0]}else{g=this.$slides.eq(d)[0]}break;case"right":d=this.left_blog_index+3;g=this.$slides.eq(d)[0];if(!g){d=this.slide_count-1;g=this.$slides.eq(d)[0]}break}if(g){this.iScroll.scrollToElement(g,this.scroll_speed,-this.blog_width,0,IScroll.ease.quadratic)}},toggle_control_visibility:function(){if(this.left_blog_index===0){this.$el.addClass("carousel_pinned_left");this.pinned_left=true}else{if(this.pinned_left){this.$el.removeClass("carousel_pinned_left");this.pinned_left=false}}if((this.right_blog_index+1)>=this.slide_count&&this.complete){this.$el.addClass("carousel_pinned_right");this.pinned_right=true}else{if(this.pinned_right){this.$el.removeClass("carousel_pinned_right");this.pinned_right=false}}},_on_scroll:function(){if(!this.is_scrolling){this.el.classList.add("is_scrolling")}this.is_scrolling=true;this.scroll_left=this._get_iscroll_x();this.scroll_remaining=this.scroller_width-(this.scroll_left+this.rect.containerWidth);this.direction=(this._cache.scroll_left>this.scroll_left)?"left":"right";this.blog_scroller();if(!this.fetching&&!this.complete&&(this.scroll_remaining<this.rect.buffer)){this.fetching=true;a.Events.trigger("SearchModel:fetch_blogs")}},_on_scroll_end:function(){this.el.classList.remove("is_scrolling");this.blog_fader();if(a.Flags.bool("search_carousel_snap")&&!this.snapping&&!this.controls_clicked){this.snap()}else{this.snapping=false}this.is_scrolling=false;this.controls_clicked=false},snap:function(){var e=this.get_blog_pos(this.left_blog_index);var f;var g=Math.abs((e/this.blog_width)-1);var d=this.$left_blog[0];if(g>0.5&&this.$slides.length>this.left_blog_index+1){d=this.$slides[this.left_blog_index+1];f=1-(g-0.5)*2}else{f=g*2}this.iScroll.scrollToElement(d,this.snap_speed*f,-this.blog_width,0,IScroll.ease.quadratic);this.snapping=true},position_slides:function(d){_.each(d,_.bind(function(e,f){var h=(f)*this.blog_width;var g=c(e);if(!g.data("in_position")){g.data("in_position",true);g.css({position:"absolute",left:h})}},this))},get_blog_pos:function(d){var e=this._get_iscroll_x();var f=-(e-(this.blog_width*(d+1)));return f},get_outer_blogs:function(){this.left_blog_index=Math.floor((this.scroll_left)/this.blog_width);this.right_blog_index=Math.floor(((this.scroll_left+this.rect.containerWidth)/this.blog_width))},cache_current_blogs:function(){this.$left_blog=this.$slides.eq(this.left_blog_index);this.$right_blog=this.$slides.eq(this.right_blog_index);this.$inner_blogs=this.$slides.slice(this.left_blog_index+1,this.right_blog_index);var d=5;this.$attached_blogs=this.$slides.filter(_.bind(function(e){return e>(this.left_blog_index-d)&&e<(this.right_blog_index+d)},this));this.$detached_blogs=this.$slides.not(this.$attached_blogs);if(a.Flags.bool("search_results_carousel_logging")){if(this.right_blog_index>this._max_impressed_blog_index){this._max_impressed_blog_index=this.right_blog_index;_.defer(_.bind(this._log_impressed_blogs,this))}}},detach_blogs:function(){_.each(this.$detached_blogs,function(d){d.style.display="none"});_.each(this.$attached_blogs,_.bind(function(e,d){e.style.display="block"},this))},blog_scroller:function(){this.get_outer_blogs();if((this._cache.left_blog_index!==this.left_blog_index)||(this._cache.right_blog_index!==this.right_blog_index)){this.cache_current_blogs();this.detach_blogs();this.toggle_control_visibility()}this.blog_fader();this._cache.right_blog_index=this.right_blog_index;this._cache.left_blog_index=this.left_blog_index;this._cache.scroll_left=this.scroll_left},blog_fader:function(){var f=this.rect.containerWidth;var e=this.get_blog_pos(this.left_blog_index);var g=Math.abs((e/this.blog_width)-1);var i=this.get_blog_pos(this.right_blog_index);var d=i-this.rect.containerWidth;var h=(i-f)/this.blog_width;this.$left_mask.css("transform","translateX("+e+"px)");this.$left_mask_fader[0].style.opacity=g;this.$right_mask.css("transform","translateX("+d+"px)");this.$right_mask_fader[0].style.opacity=h},pre_fetch:function(){if(!this.page_count){this.new_page_left=this.use_indash_tumblelogs?300:280}else{var d=this.$pages.last();this.new_page_left=d.position().left+d.width();this.show_placeholder()}},post_fetch:function(){this.hide_placeholder();this._cache_selectors();_.defer(_.bind(this.handle_new_page,this))},handle_new_page:function(){var d=this.$scroller.find(".is_new");this.scroller_width=(this.blog_width*(this.slide_count+2))-this.blog_margin;if(this.complete){this.scroller_width=(this.scroller_width-this.blog_width)}this.$slide_wrapper[0].style.width=this.scroller_width+"px";d[0].style.width=this.new_page_width+"px";d[0].style.left=this.new_page_left+"px";d[0].classList.add("fade_in");d[0].classList.remove("is_new");this.refresh_iscroll();_.defer(_.bind(this._refresh,this),d.find(this.selectors.slides));this.fetching=false},show_placeholder:function(){this.subviews.placeholder.show({left:this.new_page_left})},hide_placeholder:function(){this.subviews.placeholder.hide()},refresh_iscroll:function(){if(!this.iScroll){this.start_iscroll()}else{this.iScroll.refresh()}},no_more_blogs:function(){this.complete=true},_log_impressed_blogs:function(){var d=this.tumblelogs_collection.slice(this._last_impressed_blog_index,this._max_impressed_blog_index);_.each(d,function(g){var f=g.get("name");var e=this.tumblelogs_collection.indexOf(g);a.Search.SearchSessionLog.trigger("carousel_blog_impression",{name:f,position:e})},this);this._last_impressed_blog_index=this._max_impressed_blog_index}});a.Search.tumblelogsCarousel=b})(jQuery,Tumblr);
/*! scripts/search/views/controls/search_control_view_popover.js */
Tumblr.Search||(Tumblr.Search={});(function(c,b){var a=Backbone.View.extend({events:{"click .menu_item":"action_control_click"},initialize:function(e){this.options=e||{};this.$popover=this.$(".filter_popover");if(!this.$popover.length){return}this.$button_text=this.$(".launch_button .control_text");this.$popover_arrow=this.$(".filter_popover_arrow");this.$nipple=this.$(".filter_popover_nipple");this.$default_button=this.$button_text.clone();this.action_type=this.$el.data("searchActionType");var f=this.model.get(this.action_type);this.$items=this.$(".menu_item");var d=this.$button_text;if(f){d=this.$items.filter('[data-search-action-value="'+f+'"]')}this.set_current_to_el(d);this.listenTo(this.model,"change:"+this.action_type,this.action_type_changed);this.popover=new Tumblr.Popover({el:this.$(".launch_button"),popover:this.$popover,on_show:_.bind(this.on_show,this),on_hide:_.bind(this.on_hide,this),prevent_default_click:true,glassless:true})},action_type_changed:function(d,e){if(e==="all"){this.set_current_to_el(this.$default_button)}else{this.set_current_to_el()}},on_show:function(){this.set_nipple_position();this.$el.addClass("open")},on_hide:function(){this.$el.removeClass("open")},action_control_click:function(f){f.preventDefault();var d=c(f.currentTarget).data("searchActionValue");this.model.set(this.action_type,d)},show:function(){this.$el.show()},hide:function(){this.$el.hide()},set_nipple_position:function(){var g=this.$popover_arrow.position().left+16;var f=this.$popover.width();var e=(g/2)-(f/2);var d=(g/2)+(f/2);this.$nipple.css("left",parseInt(d));this.$popover.css("left",parseInt(e))},set_current_to_el:function(f){if(!f){var e=this.model.get(this.action_type);f=this.$items.filter('[data-search-action-value="'+e+'"]')}var d=c(f);this.$items.removeClass("active");d.addClass("active");this.$button_text.text(d.text()||"Error")}});b.SearchControlView=a})(jQuery,Tumblr.Search);
/*! scripts/search/views/controls/search_control_view_layout.js */
Tumblr.Search||(Tumblr.Search={});(function(c,b){var d=Tumblr.Search.SearchSessionLog;var a=Backbone.View.extend({events:{"click .icon":"mode_click"},initialize:function(e){this.options=_.extend({},e);this.listenTo(this.model,"change:post_view",this.update);this._should_log=false;this.update();this._should_log=true},mode_click:function(f){f.preventDefault();this.model.set("post_view",c(f.currentTarget).data("postView"))},update:function(){var e=this.model.get("post_view");this.$(".icon").removeClass("active");this.$("[data-post-view="+e+"]").addClass("active");this.log_to_session("control_click",{control:"post_view",value:e})},log_to_session:function(e,f){if(this._should_log){Tumblr.Events.trigger("Capture:push","search_page_usage",e,f);d.trigger(e,f)}},show:function(){this.$el.show()},hide:function(){this.$el.hide()}});b.PostLayoutView=a})(jQuery,Tumblr.Search);
/*! scripts/search/views/controls/search_control_nsfw.js */
(function(c,b){var a=Backbone.View.extend({events:{click:"on_click"},initialize:function(d){this.options=_.extend({},d);this.listenTo(this.model,"change:filter_nsfw",this.update,this)},update:function(){this.$el.toggleClass("nsfw_filter_enabled",this.model.get("filter_nsfw"))},on_click:function(f){f.preventDefault();var d=!(c(f.currentTarget).hasClass("nsfw_filter_enabled"));this.model.set("filter_nsfw",d);if(this.options.force_toggle){Tumblr.Events.trigger("tag:filter:toggle_nsfw")}},show:function(){this.$el.show()},hide:function(){this.$el.hide()}});b.SearchNSFWLockIcon=a})(jQuery,Tumblr);
/*! scripts/search/views/results/login_signup_lightbox.js */
(function(c,b){var a=Backbone.View.extend({className:"login_signup_lightbox",template:"#tmpl_login_signup_lightbox",url_params_string:"",options:{post_render_class:"active",delay:200,action:"default",capture:false,url_params:false},events:{click:"_on_click"},_init_events:function(){this.listenTo(b.Events,"Glass:hide",this.close)},_on_click:function(f){var d=c(f.target).data("action");if(_.contains(["login","register"],d)){this.run_capture({action:d})}},initialize:function(d){_.extend(this.options,d);var e=c(this.template);this.template=e.html();this.tagline=e.data("taglines")[this.options.action];if(this.options.url_params){this.url_params_string=this.join_url_params()}},render:function(){this._init_events();b.Glass.show(this.lightbox_close,"blue");this.$el.append(_.template(this.template,this.serialize()));_.delay(_.bind(function(){this.$el.addClass(this.options.post_render_class)},this),this.options.delay);this.run_capture({action:"open"});return this},join_url_params:function(){var e=[];for(var d in this.options.url_params){e.push(d+"="+this.options.url_params[d])}return"?"+e.join("&")},serialize:function(){return{tagline:this.tagline,url_params_regi:this.url_params_string,url_params_login:this.url_params_string}},lightbox_close:function(){this.$el.removeClass("blue")},close:function(){this.run_capture({action:"close"});this.remove()},run_capture:function(d){if(this.options.capture&&this.options.capture.context&&d){b.Events.trigger("Capture:push",this.options.capture.context,"login_signup_lightbox",d)}}});b.LoginSignupLightbox=a})(jQuery,Tumblr);
/*! scripts/search/utils/search_keycommands.js */
(function(c,b){var a=Backbone.View.extend({el:"body",suspended:false,__keydown_j:function(d){if(this.suspended){return}this.update_row_positions();this.next_row()},__keydown_k:function(d){if(this.suspended){return}this.update_row_positions();this.previous_row()},__keydown_period:function(d){if(this.suspended){return}this.elevate()},initialize:function(){this.auto_paginate=Tumblr.auto_paginate||false;this.animate_scroll=(Tumblr.animate_scroll!==undefined)?Tumblr.animate_scroll:false;this.scroll_speed=100;this.scroll_offset=100;Tumblr.Events.on("DOMEventor:keydown:j",this.__keydown_j,this);Tumblr.Events.on("DOMEventor:keydown:k",this.__keydown_k,this);Tumblr.Events.on("DOMEventor:keydown:period",this.__keydown_period,this);this.listenTo(Tumblr.Events,"keycommands:suspend",this.suspend);this.listenTo(Tumblr.Events,"keycommands:resume",this.resume)},suspend:function(d){this.suspended=true},resume:function(){this.suspended=false},next_row:function(){for(var e in this.row_positions){var d=this.row_positions[e];if(d>(this.current_position+this.scroll_offset)&&(d<this.go_to_position||!this.go_to_position)){this.go_to_position=d}}this.animate()},previous_row:function(){for(var e in this.row_positions){var d=this.row_positions[e];if(d<(this.current_position-this.scroll_offset)&&d>this.go_to_position){this.go_to_position=d}}this.animate()},get_scroll_offset:function(){return(window.pageYOffset||(document.documentElement&&document.documentElement.scrollTop)||document.body.scrollTop)},update_row_positions:function(){this.current_position=this.get_scroll_offset();this.go_to_position=0;var d={};c(".post_container").each(function(f){var e=c(this);d[f]=Math.floor(e.offset().top)});this.row_positions=d},elevate:function(){this.go_to_position=1;this.animate("slow")},animate:function(e){var d;if(!e){d=this.scroll_speed}else{d=e}if(this.go_to_position&&!this.animating){this.animating=true;c("html,body").stop().animate({scrollTop:this.go_to_position-this.scroll_offset},d,_.bind(function(){this.animating=false},this))}}});b.SearchKeyCommands=a})(jQuery,Tumblr);
/*! scripts/search/views/results/search_view.js */
(function(e,b){var f=Tumblr.Search.SearchSessionLog;var c=Backbone.View.extend({el:".l-content .search_results_container",subviews:{},scroll_timer:null,scrolling:false,below_header:false,use_indash_tumblelogs:Tumblr.Flags.bool("search_indash_blog_cards"),search_with_explore_tab:Tumblr.Flags.bool("discovery_hub_access"),events:{"click .related_searches .search_control_link":"__related_searches_click","click .post_mode .search_control_link":"__post_mode_click","click .post_view .search_control_link":"__post_view_click"},__related_searches_click:function(j){var h=e(j.currentTarget),i=h.parent();Tumblr.Events.trigger("Capture:push","search_page_usage","related_search",{position:i.index(),query:this.$search_query.val()});f.trigger("related_search",{position:i.index(),query:this.$search_query.val()});if(this.history_api){j.preventDefault();this.fill_search(h)}else{Event.returnValue=false;window.location.href=e(j.currentTarget).attr("href")+"/"+this.model.get("post_mode")}},__post_mode_click:function(j){if(this.history_api){j.preventDefault();var h=e(j.currentTarget);var i=h.data("sort-by");this.update_url(i)}},__search_form_submit:function(h){if(this.history_api){h.preventDefault();this.set_query(this.$search_query.val())}},__window_resize:function(h){Tumblr.documentWidth(h.windowWidth)},initialize:function(i){this.options=i||{};if(Tumblr&&Tumblr.Toaster){Tumblr.Toaster.disable()}this.cache_selectors();this.setup_autopager();this.listenTo(Tumblr.Events,"search:results:last_row_updated",this.update_autopager);this.listenTo(Tumblr.Events,"search:lightbox:raised",this.after_lightbox,this);this.init_posts();if(!Tumblr.Flags.bool("is_logged_in")){this.init_logged_out()}this.listenTo(Tumblr.Events,"DOMEventor:flatresize",this.__window_resize,this);this.listenTo(Tumblr.Events,"DOMEventor:flatscroll",this.scroll_watcher,this);this.listenTo(Tumblr.Events,"search:scroller:start",this.on_scroll_start,this);this.listenTo(Tumblr.Events,"search:scroller:stop",this.on_scroll_stop,this);this.listenTo(this.model,"change:query change:post_mode",this.on_url_change,this);this.listenTo(this.model,"results:refresh",this.reflow_results,this);this.listenTo(Tumblr.Events,"SearchModel:fetch:before",this.search_fetch_before,this);this.listenTo(Tumblr.Events,"SearchModel:fetch_posts:success",this.search_fetch_posts_success,this);this.listenTo(Tumblr.Events,"SearchModel:fetch_blogs:success",this.search_fetch_blogs_success,this);this.listenTo(Tumblr.Events,"SearchModel:fetch_error",this.search_fetch_error,this);this.listenTo(Tumblr.Events,"SearchModel:fetch_complete",this.search_fetch_complete,this);this.listenTo(Tumblr.Events,"SearchView:addPostsBatch",this.search_posts_added,this);this.listenTo(Tumblr.Events,"SearchTumblelogs:add:batch",this.search_insert_blog_views,this);this.listenTo(Tumblr.Events,"SearchModel:fetch_posts:end",this.on_end_posts,this);this.listenTo(Tumblr.Events,"SearchModel:fetch_blogs:end",this.on_end_blogs,this);this.listenTo(Tumblr.Prima.Events,"SearchRouter:routeChange",this.route_change,this);this.history_api=!!(window.history&&window.history.pushState);this.subviews.related=new Tumblr.SearchRelatedView();var h=this.$("[data-view-tumblelogcarousel]");if(h[0]){this.subviews.tumblelog_carousel=new Tumblr.Search.tumblelogsCarousel({el:h,className:"blogs_wrapper_inner",attributes:{"data-view-tumblelogcarousel":""}}).render()}new Tumblr.BinarySwitch({el:"html:not(.ie) .filter_popover_option_explicit_content"}).render();this.controls={};this.$(".filter_popover_menu[data-search-action-type]").each(_.bind(function(j,k){var l=new Tumblr.Search.SearchControlView({model:this.model,el:k});this.subviews[l.action_type+"_control"]=this.controls[l.action_type+"_control"]=l},this));this.controls.nsfw_lock_icon=this.subviews.nsfw_lock_icon=new Tumblr.SearchNSFWLockIcon({el:this.$("[data-action-toggle-nsfw]"),model:this.model});this.controls.post_layout=this.subviews.post_layout=new Tumblr.Search.PostLayoutView({el:this.$(".search_control.post_layout"),model:this.model});new Tumblr.SearchKeyCommands();this.$search_form.on("submit",_.bind(this.__search_form_submit,this));this.subviews.point_follow=new Tumblr.Prima.PointerFollow();this.$rows_in_view=this.$post_rows.slice(0,4);this.set_rows_in_view();this.render_required_controls()},init_posts:function(){-this.listenTo(Tumblr.Events,"Autopager:trigger",this.on_pager_trigger,this);this.subviews.posts=new Tumblr.SearchPostsView({el:this.$("[data-view-posts]"),model:this.model}).render();if(!this.model.get("has_pages")){this.handle_no_more_posts()}this.display_controls()},init_logged_out:function(){var h=e(".l-header");this.listenTo(Tumblr.Events,"SearchPopover:focus",function(){h.addClass("active")});this.listenTo(Tumblr.Events,"SearchPopover:blur",function(){h.removeClass("active")})},cache_selectors:function(){this.$body=e("body");this.$blogs_view=this.$("[data-view-tumblelogs]");this.$carousel_view_parent=this.$(".blogs_wrapper");this.$blogs_view_parent=this.$(".blogs_wrapper_carousel");this.$posts_view_parent=this.$("#posts");this.$posts_view=this.$("[data-view-posts]");this.$web_view=this.$("[data-view-web]");this.$posts_bottom=this.$("[data-view-bottom]");this.$post_modes=this.$(".post_mode .search_control_link");this.$post_views=this.$(".post_view .search_control_link");this.$search_query=e("#search_query");this.$search_form=e("#search_form");this.$post_rows=this.$posts_view.find(".search_posts_row")},__:function(h){return this.options.strings[h]||h},setup_autopager:function(){this.auto_pager=new Tumblr.Autopager({el:"#search_posts",});_.defer(_.bind(this.check_autopager_fetch,this))},update_autopager:function(h){this.auto_pager.set_buffer(h)},check_autopager_fetch:function(){if(this.auto_pager.near_bottom()){this.model.fetch_posts()}},on_pager_trigger:function(){this.model.fetch_posts()},reflow_results:function(){var l=false;var j=true;this.reflow_posts();var i=Tumblr.Flags.bool("discovery_hub_poc");if(i){var k=this.model.is_discovery_mode();var h=this.model.initially_discovery_hub;if(h!==k){window.location="/search/"+this.model.get("query");return}else{if(k){if(_.has(this.model.changed,"filter_time_range")||_.has(this.model.changed,"post_mode")){this.model.set("blogs_before",0);this.model.set("blog_page",1);this.model.set("num_blogs_shown",0);this.model.set("num_posts_shown",0);this.model.set("next_ad_offset",0);this.model.set("ad_placement_id",0)}}}}if(_.has(this.model.changed,"filter_nsfw")||_.has(this.model.changed,"query")||(this.model.is_discovery_mode())){this.reflow_blogs();this.reflow_related_searches();l=true}if(_.has(this.model.changed,"query")){this.query_change=true;e(window).scrollTop(0)}this.model.fetch_all({more_posts:j,more_blogs:l})},reflow_blogs:function(i){if(!this.subviews.tumblelog_carousel){return}this.subviews.tumblelog_carousel._remove_subviews();var h=this.$("[data-view-tumblelogcarousel]").html();this.subviews.tumblelog_carousel.remove();this.subviews.tumblelog_carousel=new Tumblr.Search.tumblelogsCarousel({template:h,className:"blogs_wrapper_inner",attributes:{"data-view-tumblelogcarousel":""}});this.$carousel_view_parent.append(this.subviews.tumblelog_carousel.render().el);if(i){this.model.fetch_blogs()}},reflow_related_searches:function(){if(!this.subviews.related){return}this.subviews.related.should_reflow=true;this.subviews.related.empty()},display_blogs:function(){if(this.model.get("has_blogs")){this.$carousel_view_parent.removeClass("empty")}else{this.$carousel_view_parent.addClass("empty")}},reflow_posts:function(h){this.clear_content();this.subviews.posts=new Tumblr.SearchPostsView({model:this.model,is_reflow:true});this.$posts_view_parent.append(this.subviews.posts.render().el);this.subviews.posts.load_next_images=true;if(h){this.model.fetch_posts()}this.render_required_controls()},clear_content:function(){if(this.subviews.posts){this.subviews.posts.remove();this.subviews.posts=null}this.render_required_controls()},render_required_controls:function(){_.each(this.controls,function(j){j.hide()});var h=this.subviews.posts;if(h){var i=h.required_controls;if(!Tumblr.Flags.bool("is_logged_in")){i=_.without(i,"nsfw_lock_icon","post_layout")}if(i){_.each(i,function(k){var j=this.controls[k];if(j){j.show()}},this)}}},search_fetch_before:function(h){this.subviews.posts_loader=new Tumblr.SearchLoaderView();this.$posts_bottom.html(this.subviews.posts_loader.el);this.subviews.posts_loader.render();Tumblr.Popover.hide_all_after(150)},search_insert_blog_views:function(h){var i=this.model.get("num_blogs_shown")||0;this.model.set("num_blogs_shown",i+h.length)},search_posts_added:function(){Tumblr.Events.trigger("DOMEventor:updateRect");Tumblr.Events.trigger("Autopager:start");if(this.subviews.posts_loader){this.subviews.posts_loader.remove()}},search_fetch_posts_success:function(i,k,h){var j=k.response;if(this.query_change&&j&&j.show_psa){Tumblr.Prima.Events.trigger("SearchRouter:navigateTo","/search/"+encodeURIComponent(this.model.get("previous_query")));window.location="/psa/search/"+encodeURIComponent(this.model.get("query"));return}if(j.posts_html&&j.posts_html.length){this.subviews.posts.append_post_html(j.posts_html);if(j.tracking_html){this.$body.append(j.tracking_html)}}if(this.subviews.related.should_reflow&&j.related_searches&&!this.search_with_explore_tab){this.subviews.related.render(j.related_searches);this.subviews.related.should_reflow=false}if(this.query_change){this.query_change=false}if(this.subviews.no_results){this.subviews.no_results.remove()}if(this.model.get("before")===-1){this.handle_no_more_posts()}this.display_controls();this.cache_selectors()},display_controls:function(){if(Tumblr.Flags.bool("no_results_landing")){this.$(".search_controls").toggleClass("empty",e("#search_posts").children().length===0)}},search_fetch_blogs_success:function(i,k,h){var j=k.response;this.display_blogs();if(this.subviews.related.should_reflow&&j.related_searches&&this.search_with_explore_tab){this.subviews.related.render(j.related_searches);this.subviews.related.should_reflow=false}},search_fetch_error:function(j,i,h){if(!!this.model.get("more_posts")){this.handle_no_more_posts()}this.display_controls()},search_fetch_complete:function(j,i,h){},on_end_posts:function(){Tumblr.Events.trigger("Autopager:stop")},on_end_blogs:function(){},handle_no_more_posts:function(){if(this.subviews.posts_loader){this.subviews.posts_loader.remove()}var h={placeholder:this.__("search tumblr"),query:this.model.get("query"),noPostsEver:(e("#search_posts").children().length===0)};this.subviews.no_results=new Tumblr.SearchEndingView(h);this.$posts_bottom.html(this.subviews.no_results.render().el)},on_scroll_start:function(){var h=_.bind(function(){this.unset_rows_in_view()},this);_.defer(h)},on_scroll_stop:function(){_.defer(_.bind(this.get_rows_in_view,this))},scroll_watcher:function(h){if(this.scroll_timer!==null){if(!this.scrolling){Tumblr.Events.trigger("search:scroller:start");this.scrolling=true}clearTimeout(this.scroll_timer)}this.scroll_timer=setTimeout(_.bind(function(){Tumblr.Events.trigger("search:scroller:stop");this.scrolling=false},this),350)},encode_query:function(h){return h.replace(/\s/g,"+").replace(/#/g,"%23").replace(/\?/g,"%3F").replace(/\//g,"%2F")},decode_query:function(h){return h.replace(/\+/g," ").replace(/%23/g,"#").replace(/%3F/g,"?").replace(/%2F/g,"/")},set_query:function(h){if(this.model.get("query")!==h&&e.trim(h)!==""){this.model.set("query",h);this.update_url(this.model.get("post_mode"))}},get_rows_in_view:function(i){if(!i){i=this.search_posts_gl?this.search_posts_gl.attached:this.$post_rows}var h=Tumblr.Prima.DOMEventor.rect();this.rows_in_view=_.filter(i,function(l){var j=e(l);if(!j.data("is-animated")){return false}var k=j.offset().top;var m=e(l).height();return(k>h.windowScrollTop)&&((k+m)<(h.windowScrollTop+h.windowHeight))});this.$rows_in_view=e(this.rows_in_view);this.set_rows_in_view()},set_rows_in_view:function(){_.each(this.$rows_in_view,function(h){h.classList.add("in_view")})},unset_rows_in_view:function(){_.each(this.$rows_in_view,function(h){h.classList.remove("in_view")})},fill_search:function(h){var i=h.text();Tumblr.Events.trigger("search:change:query",i);Tumblr.Events.trigger("search:submit")},update_url:function(i,h){if(this.history_api){h=_.extend({trigger:true},h);var j="/search/"+this.encode_query(this.model.get("query"));if(i==="recent"){j+="/recent"}Tumblr.Prima.Events.trigger("SearchRouter:navigateTo",j,h)}},after_lightbox:function(h){this.update_url(this.model.get("post_mode"),{trigger:false,replace:false})},change_post_mode_class:function(){var i=this.$body.attr("class").split(" ");var h=_.filter(i,function(j){return !j.lastIndexOf("search_results_mode")});this.$body.removeClass(h);this.$body.addClass("search_results_mode_"+this.model.get("post_mode"))},on_url_change:function(){var h=this.decode_query(this.model.get("query"));document.title=h+" | Tumblr";this.$search_query.val(h);this.change_post_mode_class();this.$post_modes.removeClass("active");_.each(this.$post_modes,_.bind(function(l){var i=e(l);var k=i.data("sort-by");var j="/search/"+this.encode_query(this.model.get("query"));if(i.data("sort-by")==="recent"){j+="/recent"}i.attr("href",j);if(k===this.model.get("post_mode")){i.addClass("active")}},this))},route_change:function(){var h=decodeURIComponent(Backbone.history.fragment.split("/")[0]);if(h!==this.encode_query(this.model.get("query"))&&!this.model.hasChanged("post_mode")){this.model.set("query",this.decode_query(h))}}});var a=Backbone.View.extend({template:"#tmpl_search_loader",className:"search_flex_loader",initialize:function(h){this.options=h||{};this.template=_.template(e(this.template).html())},render:function(){this.$el.append(this.template);var h=this.$el.offset().top;var i=e(document).height();this.$el.css("height",(i-h));return this}});var d=Backbone.View.extend({el:".related_searches",template:"#tmpl_search_related",initialize:function(){},render:function(i){if(i&&i.length){var h=_.template(e(this.template).html(),{related_searches:i});this.$el.html(h)}this.$el.css("opacity",0);this.$el.velocity({opacity:1},{duration:500});return this},empty:function(){this.$el.empty()}});var g=Backbone.View.extend({className:"search_results_end search_form_active",template:"#tmpl_search_results_end",is_focused:false,search_input:"[data-search-input]",options:{body:"",placeholder:"",query:"",},events:{"submit [data-search-input]":"submit","focus [data-search-input]":"on_focus","focusout [data-search-input]":"on_focusout","keydown [data-search-input]":"on_keydown","keyup [data-search-input]":"on_keyup"},initialize:function(h){this.options=h||{};_.defaults(this.options,h)},render:function(){if(Tumblr.Flags.bool("no_results_landing")){var h=_.sample(e(this.template).data("no-result-messages").messages);var i=_.extend({message:h},this.options);this.$el.append(e(_.template(e(this.template).html(),i)))}else{this.$el.append(e(_.template(e(this.template).html(),this.options)))}return this},on_focus:function(h){this.is_focused=true},on_focusout:function(h){this.is_focused=false},on_keyup:function(h){Tumblr.Events.trigger("search:change:query",this.$(this.search_input).val())},on_keydown:function(h){if((h.keyCode==13)&&this.is_focused){this.submit();return}},submit:function(h){Tumblr.Events.trigger("search:submit")}});b.SearchRelatedView=d;b.SearchLoaderView=a;b.SearchEndingView=g;b.SearchResultsView=c})(jQuery,Tumblr);
/*! scripts/search/search.js */
